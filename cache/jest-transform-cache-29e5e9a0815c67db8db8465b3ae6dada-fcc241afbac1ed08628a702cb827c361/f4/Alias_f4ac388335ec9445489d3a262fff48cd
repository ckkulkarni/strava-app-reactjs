45ca8322aa032395f2deaa8eb8e0cf6e
'use strict';

var anchors = require('../doc/anchors.js');
var visit = require('../visit.js');
var Node = require('./Node.js');
class Alias extends Node.NodeBase {
  constructor(source) {
    super(Node.ALIAS);
    this.source = source;
    Object.defineProperty(this, 'tag', {
      set() {
        throw new Error('Alias nodes cannot have tags');
      }
    });
  }
  /**
   * Resolve the value of this alias within `doc`, finding the last
   * instance of the `source` anchor before this node.
   */
  resolve(doc) {
    let found = undefined;
    visit.visit(doc, {
      Node: (_key, node) => {
        if (node === this) return visit.visit.BREAK;
        if (node.anchor === this.source) found = node;
      }
    });
    return found;
  }
  toJSON(_arg, ctx) {
    if (!ctx) return {
      source: this.source
    };
    const {
      anchors,
      doc,
      maxAliasCount
    } = ctx;
    const source = this.resolve(doc);
    if (!source) {
      const msg = `Unresolved alias (the anchor must be set before the alias): ${this.source}`;
      throw new ReferenceError(msg);
    }
    const data = anchors.get(source);
    /* istanbul ignore if */
    if (!data || data.res === undefined) {
      const msg = 'This should not happen: Alias anchor was not resolved?';
      throw new ReferenceError(msg);
    }
    if (maxAliasCount >= 0) {
      data.count += 1;
      if (data.aliasCount === 0) data.aliasCount = getAliasCount(doc, source, anchors);
      if (data.count * data.aliasCount > maxAliasCount) {
        const msg = 'Excessive alias count indicates a resource exhaustion attack';
        throw new ReferenceError(msg);
      }
    }
    return data.res;
  }
  toString(ctx, _onComment, _onChompKeep) {
    const src = `*${this.source}`;
    if (ctx) {
      anchors.anchorIsValid(this.source);
      if (ctx.options.verifyAliasOrder && !ctx.anchors.has(this.source)) {
        const msg = `Unresolved alias (the anchor must be set before the alias): ${this.source}`;
        throw new Error(msg);
      }
      if (ctx.implicitKey) return `${src} `;
    }
    return src;
  }
}
function getAliasCount(doc, node, anchors) {
  if (Node.isAlias(node)) {
    const source = node.resolve(doc);
    const anchor = anchors && source && anchors.get(source);
    return anchor ? anchor.count * anchor.aliasCount : 0;
  } else if (Node.isCollection(node)) {
    let count = 0;
    for (const item of node.items) {
      const c = getAliasCount(doc, item, anchors);
      if (c > count) count = c;
    }
    return count;
  } else if (Node.isPair(node)) {
    const kc = getAliasCount(doc, node.key, anchors);
    const vc = getAliasCount(doc, node.value, anchors);
    return Math.max(kc, vc);
  }
  return 1;
}
exports.Alias = Alias;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJhbmNob3JzIiwicmVxdWlyZSIsInZpc2l0IiwiTm9kZSIsIkFsaWFzIiwiTm9kZUJhc2UiLCJjb25zdHJ1Y3RvciIsInNvdXJjZSIsIkFMSUFTIiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJzZXQiLCJFcnJvciIsInJlc29sdmUiLCJkb2MiLCJmb3VuZCIsInVuZGVmaW5lZCIsIl9rZXkiLCJub2RlIiwiQlJFQUsiLCJhbmNob3IiLCJ0b0pTT04iLCJfYXJnIiwiY3R4IiwibWF4QWxpYXNDb3VudCIsIm1zZyIsIlJlZmVyZW5jZUVycm9yIiwiZGF0YSIsImdldCIsInJlcyIsImNvdW50IiwiYWxpYXNDb3VudCIsImdldEFsaWFzQ291bnQiLCJ0b1N0cmluZyIsIl9vbkNvbW1lbnQiLCJfb25DaG9tcEtlZXAiLCJzcmMiLCJhbmNob3JJc1ZhbGlkIiwib3B0aW9ucyIsInZlcmlmeUFsaWFzT3JkZXIiLCJoYXMiLCJpbXBsaWNpdEtleSIsImlzQWxpYXMiLCJpc0NvbGxlY3Rpb24iLCJpdGVtIiwiaXRlbXMiLCJjIiwiaXNQYWlyIiwia2MiLCJrZXkiLCJ2YyIsInZhbHVlIiwiTWF0aCIsIm1heCIsImV4cG9ydHMiXSwic291cmNlcyI6WyJBbGlhcy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbnZhciBhbmNob3JzID0gcmVxdWlyZSgnLi4vZG9jL2FuY2hvcnMuanMnKTtcbnZhciB2aXNpdCA9IHJlcXVpcmUoJy4uL3Zpc2l0LmpzJyk7XG52YXIgTm9kZSA9IHJlcXVpcmUoJy4vTm9kZS5qcycpO1xuXG5jbGFzcyBBbGlhcyBleHRlbmRzIE5vZGUuTm9kZUJhc2Uge1xuICAgIGNvbnN0cnVjdG9yKHNvdXJjZSkge1xuICAgICAgICBzdXBlcihOb2RlLkFMSUFTKTtcbiAgICAgICAgdGhpcy5zb3VyY2UgPSBzb3VyY2U7XG4gICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAndGFnJywge1xuICAgICAgICAgICAgc2V0KCkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQWxpYXMgbm9kZXMgY2Fubm90IGhhdmUgdGFncycpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgLyoqXG4gICAgICogUmVzb2x2ZSB0aGUgdmFsdWUgb2YgdGhpcyBhbGlhcyB3aXRoaW4gYGRvY2AsIGZpbmRpbmcgdGhlIGxhc3RcbiAgICAgKiBpbnN0YW5jZSBvZiB0aGUgYHNvdXJjZWAgYW5jaG9yIGJlZm9yZSB0aGlzIG5vZGUuXG4gICAgICovXG4gICAgcmVzb2x2ZShkb2MpIHtcbiAgICAgICAgbGV0IGZvdW5kID0gdW5kZWZpbmVkO1xuICAgICAgICB2aXNpdC52aXNpdChkb2MsIHtcbiAgICAgICAgICAgIE5vZGU6IChfa2V5LCBub2RlKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IHRoaXMpXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB2aXNpdC52aXNpdC5CUkVBSztcbiAgICAgICAgICAgICAgICBpZiAobm9kZS5hbmNob3IgPT09IHRoaXMuc291cmNlKVxuICAgICAgICAgICAgICAgICAgICBmb3VuZCA9IG5vZGU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gZm91bmQ7XG4gICAgfVxuICAgIHRvSlNPTihfYXJnLCBjdHgpIHtcbiAgICAgICAgaWYgKCFjdHgpXG4gICAgICAgICAgICByZXR1cm4geyBzb3VyY2U6IHRoaXMuc291cmNlIH07XG4gICAgICAgIGNvbnN0IHsgYW5jaG9ycywgZG9jLCBtYXhBbGlhc0NvdW50IH0gPSBjdHg7XG4gICAgICAgIGNvbnN0IHNvdXJjZSA9IHRoaXMucmVzb2x2ZShkb2MpO1xuICAgICAgICBpZiAoIXNvdXJjZSkge1xuICAgICAgICAgICAgY29uc3QgbXNnID0gYFVucmVzb2x2ZWQgYWxpYXMgKHRoZSBhbmNob3IgbXVzdCBiZSBzZXQgYmVmb3JlIHRoZSBhbGlhcyk6ICR7dGhpcy5zb3VyY2V9YDtcbiAgICAgICAgICAgIHRocm93IG5ldyBSZWZlcmVuY2VFcnJvcihtc2cpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGRhdGEgPSBhbmNob3JzLmdldChzb3VyY2UpO1xuICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi9cbiAgICAgICAgaWYgKCFkYXRhIHx8IGRhdGEucmVzID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IG1zZyA9ICdUaGlzIHNob3VsZCBub3QgaGFwcGVuOiBBbGlhcyBhbmNob3Igd2FzIG5vdCByZXNvbHZlZD8nO1xuICAgICAgICAgICAgdGhyb3cgbmV3IFJlZmVyZW5jZUVycm9yKG1zZyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1heEFsaWFzQ291bnQgPj0gMCkge1xuICAgICAgICAgICAgZGF0YS5jb3VudCArPSAxO1xuICAgICAgICAgICAgaWYgKGRhdGEuYWxpYXNDb3VudCA9PT0gMClcbiAgICAgICAgICAgICAgICBkYXRhLmFsaWFzQ291bnQgPSBnZXRBbGlhc0NvdW50KGRvYywgc291cmNlLCBhbmNob3JzKTtcbiAgICAgICAgICAgIGlmIChkYXRhLmNvdW50ICogZGF0YS5hbGlhc0NvdW50ID4gbWF4QWxpYXNDb3VudCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1zZyA9ICdFeGNlc3NpdmUgYWxpYXMgY291bnQgaW5kaWNhdGVzIGEgcmVzb3VyY2UgZXhoYXVzdGlvbiBhdHRhY2snO1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBSZWZlcmVuY2VFcnJvcihtc2cpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBkYXRhLnJlcztcbiAgICB9XG4gICAgdG9TdHJpbmcoY3R4LCBfb25Db21tZW50LCBfb25DaG9tcEtlZXApIHtcbiAgICAgICAgY29uc3Qgc3JjID0gYCoke3RoaXMuc291cmNlfWA7XG4gICAgICAgIGlmIChjdHgpIHtcbiAgICAgICAgICAgIGFuY2hvcnMuYW5jaG9ySXNWYWxpZCh0aGlzLnNvdXJjZSk7XG4gICAgICAgICAgICBpZiAoY3R4Lm9wdGlvbnMudmVyaWZ5QWxpYXNPcmRlciAmJiAhY3R4LmFuY2hvcnMuaGFzKHRoaXMuc291cmNlKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1zZyA9IGBVbnJlc29sdmVkIGFsaWFzICh0aGUgYW5jaG9yIG11c3QgYmUgc2V0IGJlZm9yZSB0aGUgYWxpYXMpOiAke3RoaXMuc291cmNlfWA7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoY3R4LmltcGxpY2l0S2V5KVxuICAgICAgICAgICAgICAgIHJldHVybiBgJHtzcmN9IGA7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHNyYztcbiAgICB9XG59XG5mdW5jdGlvbiBnZXRBbGlhc0NvdW50KGRvYywgbm9kZSwgYW5jaG9ycykge1xuICAgIGlmIChOb2RlLmlzQWxpYXMobm9kZSkpIHtcbiAgICAgICAgY29uc3Qgc291cmNlID0gbm9kZS5yZXNvbHZlKGRvYyk7XG4gICAgICAgIGNvbnN0IGFuY2hvciA9IGFuY2hvcnMgJiYgc291cmNlICYmIGFuY2hvcnMuZ2V0KHNvdXJjZSk7XG4gICAgICAgIHJldHVybiBhbmNob3IgPyBhbmNob3IuY291bnQgKiBhbmNob3IuYWxpYXNDb3VudCA6IDA7XG4gICAgfVxuICAgIGVsc2UgaWYgKE5vZGUuaXNDb2xsZWN0aW9uKG5vZGUpKSB7XG4gICAgICAgIGxldCBjb3VudCA9IDA7XG4gICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBub2RlLml0ZW1zKSB7XG4gICAgICAgICAgICBjb25zdCBjID0gZ2V0QWxpYXNDb3VudChkb2MsIGl0ZW0sIGFuY2hvcnMpO1xuICAgICAgICAgICAgaWYgKGMgPiBjb3VudClcbiAgICAgICAgICAgICAgICBjb3VudCA9IGM7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNvdW50O1xuICAgIH1cbiAgICBlbHNlIGlmIChOb2RlLmlzUGFpcihub2RlKSkge1xuICAgICAgICBjb25zdCBrYyA9IGdldEFsaWFzQ291bnQoZG9jLCBub2RlLmtleSwgYW5jaG9ycyk7XG4gICAgICAgIGNvbnN0IHZjID0gZ2V0QWxpYXNDb3VudChkb2MsIG5vZGUudmFsdWUsIGFuY2hvcnMpO1xuICAgICAgICByZXR1cm4gTWF0aC5tYXgoa2MsIHZjKTtcbiAgICB9XG4gICAgcmV0dXJuIDE7XG59XG5cbmV4cG9ydHMuQWxpYXMgPSBBbGlhcztcbiJdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWTs7QUFFWixJQUFJQSxPQUFPLEdBQUdDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQztBQUMxQyxJQUFJQyxLQUFLLEdBQUdELE9BQU8sQ0FBQyxhQUFhLENBQUM7QUFDbEMsSUFBSUUsSUFBSSxHQUFHRixPQUFPLENBQUMsV0FBVyxDQUFDO0FBRS9CLE1BQU1HLEtBQUssU0FBU0QsSUFBSSxDQUFDRSxRQUFRLENBQUM7RUFDOUJDLFdBQVdBLENBQUNDLE1BQU0sRUFBRTtJQUNoQixLQUFLLENBQUNKLElBQUksQ0FBQ0ssS0FBSyxDQUFDO0lBQ2pCLElBQUksQ0FBQ0QsTUFBTSxHQUFHQSxNQUFNO0lBQ3BCRSxNQUFNLENBQUNDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFO01BQy9CQyxHQUFHQSxDQUFBLEVBQUc7UUFDRixNQUFNLElBQUlDLEtBQUssQ0FBQyw4QkFBOEIsQ0FBQztNQUNuRDtJQUNKLENBQUMsQ0FBQztFQUNOO0VBQ0E7QUFDSjtBQUNBO0FBQ0E7RUFDSUMsT0FBT0EsQ0FBQ0MsR0FBRyxFQUFFO0lBQ1QsSUFBSUMsS0FBSyxHQUFHQyxTQUFTO0lBQ3JCZCxLQUFLLENBQUNBLEtBQUssQ0FBQ1ksR0FBRyxFQUFFO01BQ2JYLElBQUksRUFBRUEsQ0FBQ2MsSUFBSSxFQUFFQyxJQUFJLEtBQUs7UUFDbEIsSUFBSUEsSUFBSSxLQUFLLElBQUksRUFDYixPQUFPaEIsS0FBSyxDQUFDQSxLQUFLLENBQUNpQixLQUFLO1FBQzVCLElBQUlELElBQUksQ0FBQ0UsTUFBTSxLQUFLLElBQUksQ0FBQ2IsTUFBTSxFQUMzQlEsS0FBSyxHQUFHRyxJQUFJO01BQ3BCO0lBQ0osQ0FBQyxDQUFDO0lBQ0YsT0FBT0gsS0FBSztFQUNoQjtFQUNBTSxNQUFNQSxDQUFDQyxJQUFJLEVBQUVDLEdBQUcsRUFBRTtJQUNkLElBQUksQ0FBQ0EsR0FBRyxFQUNKLE9BQU87TUFBRWhCLE1BQU0sRUFBRSxJQUFJLENBQUNBO0lBQU8sQ0FBQztJQUNsQyxNQUFNO01BQUVQLE9BQU87TUFBRWMsR0FBRztNQUFFVTtJQUFjLENBQUMsR0FBR0QsR0FBRztJQUMzQyxNQUFNaEIsTUFBTSxHQUFHLElBQUksQ0FBQ00sT0FBTyxDQUFDQyxHQUFHLENBQUM7SUFDaEMsSUFBSSxDQUFDUCxNQUFNLEVBQUU7TUFDVCxNQUFNa0IsR0FBRyxHQUFJLCtEQUE4RCxJQUFJLENBQUNsQixNQUFPLEVBQUM7TUFDeEYsTUFBTSxJQUFJbUIsY0FBYyxDQUFDRCxHQUFHLENBQUM7SUFDakM7SUFDQSxNQUFNRSxJQUFJLEdBQUczQixPQUFPLENBQUM0QixHQUFHLENBQUNyQixNQUFNLENBQUM7SUFDaEM7SUFDQSxJQUFJLENBQUNvQixJQUFJLElBQUlBLElBQUksQ0FBQ0UsR0FBRyxLQUFLYixTQUFTLEVBQUU7TUFDakMsTUFBTVMsR0FBRyxHQUFHLHdEQUF3RDtNQUNwRSxNQUFNLElBQUlDLGNBQWMsQ0FBQ0QsR0FBRyxDQUFDO0lBQ2pDO0lBQ0EsSUFBSUQsYUFBYSxJQUFJLENBQUMsRUFBRTtNQUNwQkcsSUFBSSxDQUFDRyxLQUFLLElBQUksQ0FBQztNQUNmLElBQUlILElBQUksQ0FBQ0ksVUFBVSxLQUFLLENBQUMsRUFDckJKLElBQUksQ0FBQ0ksVUFBVSxHQUFHQyxhQUFhLENBQUNsQixHQUFHLEVBQUVQLE1BQU0sRUFBRVAsT0FBTyxDQUFDO01BQ3pELElBQUkyQixJQUFJLENBQUNHLEtBQUssR0FBR0gsSUFBSSxDQUFDSSxVQUFVLEdBQUdQLGFBQWEsRUFBRTtRQUM5QyxNQUFNQyxHQUFHLEdBQUcsOERBQThEO1FBQzFFLE1BQU0sSUFBSUMsY0FBYyxDQUFDRCxHQUFHLENBQUM7TUFDakM7SUFDSjtJQUNBLE9BQU9FLElBQUksQ0FBQ0UsR0FBRztFQUNuQjtFQUNBSSxRQUFRQSxDQUFDVixHQUFHLEVBQUVXLFVBQVUsRUFBRUMsWUFBWSxFQUFFO0lBQ3BDLE1BQU1DLEdBQUcsR0FBSSxJQUFHLElBQUksQ0FBQzdCLE1BQU8sRUFBQztJQUM3QixJQUFJZ0IsR0FBRyxFQUFFO01BQ0x2QixPQUFPLENBQUNxQyxhQUFhLENBQUMsSUFBSSxDQUFDOUIsTUFBTSxDQUFDO01BQ2xDLElBQUlnQixHQUFHLENBQUNlLE9BQU8sQ0FBQ0MsZ0JBQWdCLElBQUksQ0FBQ2hCLEdBQUcsQ0FBQ3ZCLE9BQU8sQ0FBQ3dDLEdBQUcsQ0FBQyxJQUFJLENBQUNqQyxNQUFNLENBQUMsRUFBRTtRQUMvRCxNQUFNa0IsR0FBRyxHQUFJLCtEQUE4RCxJQUFJLENBQUNsQixNQUFPLEVBQUM7UUFDeEYsTUFBTSxJQUFJSyxLQUFLLENBQUNhLEdBQUcsQ0FBQztNQUN4QjtNQUNBLElBQUlGLEdBQUcsQ0FBQ2tCLFdBQVcsRUFDZixPQUFRLEdBQUVMLEdBQUksR0FBRTtJQUN4QjtJQUNBLE9BQU9BLEdBQUc7RUFDZDtBQUNKO0FBQ0EsU0FBU0osYUFBYUEsQ0FBQ2xCLEdBQUcsRUFBRUksSUFBSSxFQUFFbEIsT0FBTyxFQUFFO0VBQ3ZDLElBQUlHLElBQUksQ0FBQ3VDLE9BQU8sQ0FBQ3hCLElBQUksQ0FBQyxFQUFFO0lBQ3BCLE1BQU1YLE1BQU0sR0FBR1csSUFBSSxDQUFDTCxPQUFPLENBQUNDLEdBQUcsQ0FBQztJQUNoQyxNQUFNTSxNQUFNLEdBQUdwQixPQUFPLElBQUlPLE1BQU0sSUFBSVAsT0FBTyxDQUFDNEIsR0FBRyxDQUFDckIsTUFBTSxDQUFDO0lBQ3ZELE9BQU9hLE1BQU0sR0FBR0EsTUFBTSxDQUFDVSxLQUFLLEdBQUdWLE1BQU0sQ0FBQ1csVUFBVSxHQUFHLENBQUM7RUFDeEQsQ0FBQyxNQUNJLElBQUk1QixJQUFJLENBQUN3QyxZQUFZLENBQUN6QixJQUFJLENBQUMsRUFBRTtJQUM5QixJQUFJWSxLQUFLLEdBQUcsQ0FBQztJQUNiLEtBQUssTUFBTWMsSUFBSSxJQUFJMUIsSUFBSSxDQUFDMkIsS0FBSyxFQUFFO01BQzNCLE1BQU1DLENBQUMsR0FBR2QsYUFBYSxDQUFDbEIsR0FBRyxFQUFFOEIsSUFBSSxFQUFFNUMsT0FBTyxDQUFDO01BQzNDLElBQUk4QyxDQUFDLEdBQUdoQixLQUFLLEVBQ1RBLEtBQUssR0FBR2dCLENBQUM7SUFDakI7SUFDQSxPQUFPaEIsS0FBSztFQUNoQixDQUFDLE1BQ0ksSUFBSTNCLElBQUksQ0FBQzRDLE1BQU0sQ0FBQzdCLElBQUksQ0FBQyxFQUFFO0lBQ3hCLE1BQU04QixFQUFFLEdBQUdoQixhQUFhLENBQUNsQixHQUFHLEVBQUVJLElBQUksQ0FBQytCLEdBQUcsRUFBRWpELE9BQU8sQ0FBQztJQUNoRCxNQUFNa0QsRUFBRSxHQUFHbEIsYUFBYSxDQUFDbEIsR0FBRyxFQUFFSSxJQUFJLENBQUNpQyxLQUFLLEVBQUVuRCxPQUFPLENBQUM7SUFDbEQsT0FBT29ELElBQUksQ0FBQ0MsR0FBRyxDQUFDTCxFQUFFLEVBQUVFLEVBQUUsQ0FBQztFQUMzQjtFQUNBLE9BQU8sQ0FBQztBQUNaO0FBRUFJLE9BQU8sQ0FBQ2xELEtBQUssR0FBR0EsS0FBSyJ9
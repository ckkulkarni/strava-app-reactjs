{"version":3,"names":["anchors","require","visit","Node","Alias","NodeBase","constructor","source","ALIAS","Object","defineProperty","set","Error","resolve","doc","found","undefined","_key","node","BREAK","anchor","toJSON","_arg","ctx","maxAliasCount","msg","ReferenceError","data","get","res","count","aliasCount","getAliasCount","toString","_onComment","_onChompKeep","src","anchorIsValid","options","verifyAliasOrder","has","implicitKey","isAlias","isCollection","item","items","c","isPair","kc","key","vc","value","Math","max","exports"],"sources":["Alias.js"],"sourcesContent":["'use strict';\n\nvar anchors = require('../doc/anchors.js');\nvar visit = require('../visit.js');\nvar Node = require('./Node.js');\n\nclass Alias extends Node.NodeBase {\n    constructor(source) {\n        super(Node.ALIAS);\n        this.source = source;\n        Object.defineProperty(this, 'tag', {\n            set() {\n                throw new Error('Alias nodes cannot have tags');\n            }\n        });\n    }\n    /**\n     * Resolve the value of this alias within `doc`, finding the last\n     * instance of the `source` anchor before this node.\n     */\n    resolve(doc) {\n        let found = undefined;\n        visit.visit(doc, {\n            Node: (_key, node) => {\n                if (node === this)\n                    return visit.visit.BREAK;\n                if (node.anchor === this.source)\n                    found = node;\n            }\n        });\n        return found;\n    }\n    toJSON(_arg, ctx) {\n        if (!ctx)\n            return { source: this.source };\n        const { anchors, doc, maxAliasCount } = ctx;\n        const source = this.resolve(doc);\n        if (!source) {\n            const msg = `Unresolved alias (the anchor must be set before the alias): ${this.source}`;\n            throw new ReferenceError(msg);\n        }\n        const data = anchors.get(source);\n        /* istanbul ignore if */\n        if (!data || data.res === undefined) {\n            const msg = 'This should not happen: Alias anchor was not resolved?';\n            throw new ReferenceError(msg);\n        }\n        if (maxAliasCount >= 0) {\n            data.count += 1;\n            if (data.aliasCount === 0)\n                data.aliasCount = getAliasCount(doc, source, anchors);\n            if (data.count * data.aliasCount > maxAliasCount) {\n                const msg = 'Excessive alias count indicates a resource exhaustion attack';\n                throw new ReferenceError(msg);\n            }\n        }\n        return data.res;\n    }\n    toString(ctx, _onComment, _onChompKeep) {\n        const src = `*${this.source}`;\n        if (ctx) {\n            anchors.anchorIsValid(this.source);\n            if (ctx.options.verifyAliasOrder && !ctx.anchors.has(this.source)) {\n                const msg = `Unresolved alias (the anchor must be set before the alias): ${this.source}`;\n                throw new Error(msg);\n            }\n            if (ctx.implicitKey)\n                return `${src} `;\n        }\n        return src;\n    }\n}\nfunction getAliasCount(doc, node, anchors) {\n    if (Node.isAlias(node)) {\n        const source = node.resolve(doc);\n        const anchor = anchors && source && anchors.get(source);\n        return anchor ? anchor.count * anchor.aliasCount : 0;\n    }\n    else if (Node.isCollection(node)) {\n        let count = 0;\n        for (const item of node.items) {\n            const c = getAliasCount(doc, item, anchors);\n            if (c > count)\n                count = c;\n        }\n        return count;\n    }\n    else if (Node.isPair(node)) {\n        const kc = getAliasCount(doc, node.key, anchors);\n        const vc = getAliasCount(doc, node.value, anchors);\n        return Math.max(kc, vc);\n    }\n    return 1;\n}\n\nexports.Alias = Alias;\n"],"mappings":"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"}
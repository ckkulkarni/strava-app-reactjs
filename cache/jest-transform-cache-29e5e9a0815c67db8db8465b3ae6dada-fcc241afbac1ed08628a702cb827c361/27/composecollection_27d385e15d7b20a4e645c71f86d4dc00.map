{"version":3,"names":["Node","require","Scalar","resolveBlockMap","resolveBlockSeq","resolveFlowCollection","composeCollection","CN","ctx","token","tagToken","onError","coll","type","tagName","directives","source","msg","Coll","constructor","tag","expType","isMap","schema","tags","find","t","collection","kt","knownTags","push","Object","assign","default","res","resolve","options","node","isNode","range","format","exports"],"sources":["compose-collection.js"],"sourcesContent":["'use strict';\n\nvar Node = require('../nodes/Node.js');\nvar Scalar = require('../nodes/Scalar.js');\nvar resolveBlockMap = require('./resolve-block-map.js');\nvar resolveBlockSeq = require('./resolve-block-seq.js');\nvar resolveFlowCollection = require('./resolve-flow-collection.js');\n\nfunction composeCollection(CN, ctx, token, tagToken, onError) {\n    let coll;\n    switch (token.type) {\n        case 'block-map': {\n            coll = resolveBlockMap.resolveBlockMap(CN, ctx, token, onError);\n            break;\n        }\n        case 'block-seq': {\n            coll = resolveBlockSeq.resolveBlockSeq(CN, ctx, token, onError);\n            break;\n        }\n        case 'flow-collection': {\n            coll = resolveFlowCollection.resolveFlowCollection(CN, ctx, token, onError);\n            break;\n        }\n    }\n    if (!tagToken)\n        return coll;\n    const tagName = ctx.directives.tagName(tagToken.source, msg => onError(tagToken, 'TAG_RESOLVE_FAILED', msg));\n    if (!tagName)\n        return coll;\n    // Cast needed due to: https://github.com/Microsoft/TypeScript/issues/3841\n    const Coll = coll.constructor;\n    if (tagName === '!' || tagName === Coll.tagName) {\n        coll.tag = Coll.tagName;\n        return coll;\n    }\n    const expType = Node.isMap(coll) ? 'map' : 'seq';\n    let tag = ctx.schema.tags.find(t => t.collection === expType && t.tag === tagName);\n    if (!tag) {\n        const kt = ctx.schema.knownTags[tagName];\n        if (kt && kt.collection === expType) {\n            ctx.schema.tags.push(Object.assign({}, kt, { default: false }));\n            tag = kt;\n        }\n        else {\n            onError(tagToken, 'TAG_RESOLVE_FAILED', `Unresolved tag: ${tagName}`, true);\n            coll.tag = tagName;\n            return coll;\n        }\n    }\n    const res = tag.resolve(coll, msg => onError(tagToken, 'TAG_RESOLVE_FAILED', msg), ctx.options);\n    const node = Node.isNode(res)\n        ? res\n        : new Scalar.Scalar(res);\n    node.range = coll.range;\n    node.tag = tagName;\n    if (tag?.format)\n        node.format = tag.format;\n    return node;\n}\n\nexports.composeCollection = composeCollection;\n"],"mappings":"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"}
{"version":3,"names":["time_1","require","uncaught_exception_manager_1","__importDefault","util_1","value_checker_1","UserCodeRunner","run","argsArray","thisArg","fn","timeoutInMilliseconds","callbackPromise","Promise","resolve","reject","push","error","result","doesHaveValue","fnReturn","apply","e","Error","default","format","racingPromises","callbackInterface","length","promiseInterface","then","exceptionHandler","uncaughtExceptionPromise","registerHandler","finalPromise","race","timeoutMessage","toString","wrapPromiseWithTimeout","unregisterHandler","exports"],"sources":["../src/user_code_runner.ts"],"sourcesContent":["import { wrapPromiseWithTimeout } from './time'\nimport UncaughtExceptionManager from './uncaught_exception_manager'\nimport util from 'util'\nimport { doesHaveValue } from './value_checker'\n\nexport interface IRunRequest {\n  argsArray: any[]\n  thisArg: any\n  fn: Function\n  timeoutInMilliseconds: number\n}\n\nexport interface IRunResponse {\n  error?: any\n  result?: any\n}\n\nconst UserCodeRunner = {\n  async run({\n    argsArray,\n    thisArg,\n    fn,\n    timeoutInMilliseconds,\n  }: IRunRequest): Promise<IRunResponse> {\n    const callbackPromise = new Promise((resolve, reject) => {\n      argsArray.push((error: Error, result: IRunResponse) => {\n        if (doesHaveValue(error)) {\n          reject(error)\n        } else {\n          resolve(result)\n        }\n      })\n    })\n\n    let fnReturn\n    try {\n      fnReturn = fn.apply(thisArg, argsArray)\n    } catch (e) {\n      const error = e instanceof Error ? e : util.format(e)\n      return { error }\n    }\n\n    const racingPromises = []\n    const callbackInterface = fn.length === argsArray.length\n    const promiseInterface =\n      doesHaveValue(fnReturn) && typeof fnReturn.then === 'function'\n\n    if (callbackInterface && promiseInterface) {\n      return {\n        error: new Error(\n          'function uses multiple asynchronous interfaces: callback and promise\\n' +\n            'to use the callback interface: do not return a promise\\n' +\n            'to use the promise interface: remove the last argument to the function'\n        ),\n      }\n    } else if (callbackInterface) {\n      racingPromises.push(callbackPromise)\n    } else if (promiseInterface) {\n      racingPromises.push(fnReturn)\n    } else {\n      return { result: fnReturn }\n    }\n\n    let exceptionHandler\n    const uncaughtExceptionPromise = new Promise((resolve, reject) => {\n      exceptionHandler = reject\n      UncaughtExceptionManager.registerHandler(exceptionHandler)\n    })\n    racingPromises.push(uncaughtExceptionPromise)\n\n    let finalPromise = Promise.race(racingPromises)\n    if (timeoutInMilliseconds >= 0) {\n      const timeoutMessage =\n        'function timed out, ensure the ' +\n        (callbackInterface ? 'callback is executed' : 'promise resolves') +\n        ` within ${timeoutInMilliseconds.toString()} milliseconds`\n      finalPromise = wrapPromiseWithTimeout(\n        finalPromise,\n        timeoutInMilliseconds,\n        timeoutMessage\n      )\n    }\n\n    let error, result\n    try {\n      result = await finalPromise\n    } catch (e) {\n      if (e instanceof Error) {\n        error = e\n      } else if (doesHaveValue(e)) {\n        error = util.format(e)\n      } else {\n        error = new Error('Promise rejected without a reason')\n      }\n    }\n\n    UncaughtExceptionManager.unregisterHandler(exceptionHandler)\n\n    return { error, result }\n  },\n}\n\nexport default UserCodeRunner\n"],"mappings":"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"}
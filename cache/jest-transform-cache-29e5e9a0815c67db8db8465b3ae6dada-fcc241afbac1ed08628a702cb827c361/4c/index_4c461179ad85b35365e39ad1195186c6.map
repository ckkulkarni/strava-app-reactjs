{"version":3,"names":["pickle_parser_1","require","gherkin_document_parser_1","messages","__importStar","value_checker_1","buildEmptyMapping","stepDefinitions","mapping","forEach","stepDefinition","id","code","unwrappedCode","toString","line","pattern","expression","source","patternType","constructor","name","matches","uri","unexecutedStatuses","TestStepResultStatus","AMBIGUOUS","SKIPPED","UNDEFINED","buildMapping","eventDataCollector","getTestCaseAttempts","testCaseAttempt","pickleStepMap","getPickleStepMap","pickle","gherkinStepMap","getGherkinStepMap","gherkinDocument","testCase","testSteps","testStep","doesHaveValue","pickleStepId","stepDefinitionIds","length","stepDefinitionId","pickleStep","gherkinStep","astNodeIds","match","location","text","duration","status","stepResults","includes","push","normalizeDuration","Number","MIN_SAFE_INTEGER","TimeConversion","durationToMilliseconds","buildResult","Object","keys","map","rest","sortedMatches","sort","a","b","result","durations","filter","m","totalMilliseconds","reduce","acc","x","meanDuration","millisecondsToDuration","getUsage","exports"],"sources":["../../../../src/formatter/helpers/usage_helpers/index.ts"],"sourcesContent":["import { getPickleStepMap } from '../pickle_parser'\nimport { getGherkinStepMap } from '../gherkin_document_parser'\nimport * as messages from '@cucumber/messages'\nimport StepDefinition from '../../../models/step_definition'\nimport { doesHaveValue } from '../../../value_checker'\nimport EventDataCollector from '../event_data_collector'\n\nexport interface IUsageMatch {\n  duration?: messages.Duration\n  line: number\n  text: string\n  uri: string\n}\n\nexport interface IUsage {\n  code: string\n  line: number\n  matches: IUsageMatch[]\n  meanDuration?: messages.Duration\n  pattern: string\n  patternType: string\n  uri: string\n}\n\nexport interface IGetUsageRequest {\n  eventDataCollector: EventDataCollector\n  stepDefinitions: StepDefinition[]\n}\n\nfunction buildEmptyMapping(\n  stepDefinitions: StepDefinition[]\n): Record<string, IUsage> {\n  const mapping: Record<string, IUsage> = {}\n  stepDefinitions.forEach((stepDefinition) => {\n    mapping[stepDefinition.id] = {\n      code: stepDefinition.unwrappedCode.toString(),\n      line: stepDefinition.line,\n      pattern: stepDefinition.expression.source,\n      patternType: stepDefinition.expression.constructor.name,\n      matches: [],\n      uri: stepDefinition.uri,\n    }\n  })\n  return mapping\n}\n\nconst unexecutedStatuses: readonly messages.TestStepResultStatus[] = [\n  messages.TestStepResultStatus.AMBIGUOUS,\n  messages.TestStepResultStatus.SKIPPED,\n  messages.TestStepResultStatus.UNDEFINED,\n]\n\nfunction buildMapping({\n  stepDefinitions,\n  eventDataCollector,\n}: IGetUsageRequest): Record<string, IUsage> {\n  const mapping = buildEmptyMapping(stepDefinitions)\n  eventDataCollector.getTestCaseAttempts().forEach((testCaseAttempt) => {\n    const pickleStepMap = getPickleStepMap(testCaseAttempt.pickle)\n    const gherkinStepMap = getGherkinStepMap(testCaseAttempt.gherkinDocument)\n    testCaseAttempt.testCase.testSteps.forEach((testStep) => {\n      if (\n        doesHaveValue(testStep.pickleStepId) &&\n        testStep.stepDefinitionIds.length === 1\n      ) {\n        const stepDefinitionId = testStep.stepDefinitionIds[0]\n        const pickleStep = pickleStepMap[testStep.pickleStepId]\n        const gherkinStep = gherkinStepMap[pickleStep.astNodeIds[0]]\n        const match: IUsageMatch = {\n          line: gherkinStep.location.line,\n          text: pickleStep.text,\n          uri: testCaseAttempt.pickle.uri,\n        }\n        const { duration, status } = testCaseAttempt.stepResults[testStep.id]\n        if (!unexecutedStatuses.includes(status) && doesHaveValue(duration)) {\n          match.duration = duration\n        }\n        if (doesHaveValue(mapping[stepDefinitionId])) {\n          mapping[stepDefinitionId].matches.push(match)\n        }\n      }\n    })\n  })\n  return mapping\n}\n\nfunction normalizeDuration(duration?: messages.Duration): number {\n  if (duration == null) {\n    return Number.MIN_SAFE_INTEGER\n  }\n  return messages.TimeConversion.durationToMilliseconds(duration)\n}\n\nfunction buildResult(mapping: Record<string, IUsage>): IUsage[] {\n  return Object.keys(mapping)\n    .map((stepDefinitionId) => {\n      const { matches, ...rest } = mapping[stepDefinitionId]\n      const sortedMatches = matches.sort((a: IUsageMatch, b: IUsageMatch) => {\n        if (a.duration === b.duration) {\n          return a.text < b.text ? -1 : 1\n        }\n        return normalizeDuration(b.duration) - normalizeDuration(a.duration)\n      })\n      const result = { matches: sortedMatches, ...rest }\n      const durations: messages.Duration[] = matches\n        .filter((m) => m.duration != null)\n        .map((m) => m.duration)\n      if (durations.length > 0) {\n        const totalMilliseconds = durations.reduce(\n          (acc, x) => acc + messages.TimeConversion.durationToMilliseconds(x),\n          0\n        )\n        result.meanDuration = messages.TimeConversion.millisecondsToDuration(\n          totalMilliseconds / durations.length\n        )\n      }\n      return result\n    })\n    .sort(\n      (a: IUsage, b: IUsage) =>\n        normalizeDuration(b.meanDuration) - normalizeDuration(a.meanDuration)\n    )\n}\n\nexport function getUsage({\n  stepDefinitions,\n  eventDataCollector,\n}: IGetUsageRequest): IUsage[] {\n  const mapping = buildMapping({ stepDefinitions, eventDataCollector })\n  return buildResult(mapping)\n}\n"],"mappings":"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"}
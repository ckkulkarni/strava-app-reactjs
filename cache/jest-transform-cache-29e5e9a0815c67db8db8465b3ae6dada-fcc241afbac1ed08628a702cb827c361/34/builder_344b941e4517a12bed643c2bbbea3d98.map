{"version":3,"names":["get_color_fns_1","__importDefault","require","javascript_snippet_syntax_1","path_1","step_definition_snippet_builder_1","value_checker_1","snippet_syntax_1","url_1","formatters_1","importer","FormatterBuilder","build","type","options","FormatterConstructor","getConstructorByType","cwd","colorFns","default","stream","env","parsedArgvOptions","colorsEnabled","snippetBuilder","getStepDefinitionSnippetBuilder","snippetInterface","snippetSyntax","supportCodeLibrary","formatters","getFormatters","loadCustomClass","doesNotHaveValue","SnippetInterface","Synchronous","Syntax","doesHaveValue","parameterTypeRegistry","descriptor","normalised","startsWith","pathToFileURL","resolve","URL","CustomClass","loadFile","resolveConstructor","Error","urlOrName","result","fileURLToPath","error","code","ImportedCode","exports"],"sources":["../../src/formatter/builder.ts"],"sourcesContent":["import getColorFns from './get_color_fns'\nimport JavascriptSnippetSyntax from './step_definition_snippet_builder/javascript_snippet_syntax'\nimport path from 'path'\nimport StepDefinitionSnippetBuilder from './step_definition_snippet_builder'\nimport { ISupportCodeLibrary } from '../support_code_library_builder/types'\nimport Formatter, {\n  FormatOptions,\n  IFormatterCleanupFn,\n  IFormatterLogFn,\n} from '.'\nimport { doesHaveValue, doesNotHaveValue } from '../value_checker'\nimport { EventEmitter } from 'events'\nimport EventDataCollector from './helpers/event_data_collector'\nimport { Writable as WritableStream } from 'stream'\nimport { SnippetInterface } from './step_definition_snippet_builder/snippet_syntax'\nimport { fileURLToPath, pathToFileURL } from 'url'\nimport Formatters from './helpers/formatters'\n// eslint-disable-next-line @typescript-eslint/no-var-requires\nconst { importer } = require('../importer')\n\ninterface IGetStepDefinitionSnippetBuilderOptions {\n  cwd: string\n  snippetInterface?: SnippetInterface\n  snippetSyntax?: string\n  supportCodeLibrary: ISupportCodeLibrary\n}\n\nexport interface IBuildOptions {\n  env: NodeJS.ProcessEnv\n  cwd: string\n  eventBroadcaster: EventEmitter\n  eventDataCollector: EventDataCollector\n  log: IFormatterLogFn\n  parsedArgvOptions: FormatOptions\n  stream: WritableStream\n  cleanup: IFormatterCleanupFn\n  supportCodeLibrary: ISupportCodeLibrary\n}\n\nconst FormatterBuilder = {\n  async build(type: string, options: IBuildOptions): Promise<Formatter> {\n    const FormatterConstructor = await FormatterBuilder.getConstructorByType(\n      type,\n      options.cwd\n    )\n    const colorFns = getColorFns(\n      options.stream,\n      options.env,\n      options.parsedArgvOptions.colorsEnabled\n    )\n    const snippetBuilder =\n      await FormatterBuilder.getStepDefinitionSnippetBuilder({\n        cwd: options.cwd,\n        snippetInterface: options.parsedArgvOptions.snippetInterface,\n        snippetSyntax: options.parsedArgvOptions.snippetSyntax,\n        supportCodeLibrary: options.supportCodeLibrary,\n      })\n    return new FormatterConstructor({\n      colorFns,\n      snippetBuilder,\n      ...options,\n    })\n  },\n\n  async getConstructorByType(\n    type: string,\n    cwd: string\n  ): Promise<typeof Formatter> {\n    const formatters: Record<string, typeof Formatter> =\n      Formatters.getFormatters()\n\n    return formatters[type]\n      ? formatters[type]\n      : await FormatterBuilder.loadCustomClass('formatter', type, cwd)\n  },\n\n  async getStepDefinitionSnippetBuilder({\n    cwd,\n    snippetInterface,\n    snippetSyntax,\n    supportCodeLibrary,\n  }: IGetStepDefinitionSnippetBuilderOptions) {\n    if (doesNotHaveValue(snippetInterface)) {\n      snippetInterface = SnippetInterface.Synchronous\n    }\n    let Syntax = JavascriptSnippetSyntax\n    if (doesHaveValue(snippetSyntax)) {\n      Syntax = await FormatterBuilder.loadCustomClass(\n        'syntax',\n        snippetSyntax,\n        cwd\n      )\n    }\n    return new StepDefinitionSnippetBuilder({\n      snippetSyntax: new Syntax(snippetInterface),\n      parameterTypeRegistry: supportCodeLibrary.parameterTypeRegistry,\n    })\n  },\n\n  async loadCustomClass(\n    type: 'formatter' | 'syntax',\n    descriptor: string,\n    cwd: string\n  ) {\n    let normalised: URL | string = descriptor\n    if (descriptor.startsWith('.')) {\n      normalised = pathToFileURL(path.resolve(cwd, descriptor))\n    } else if (descriptor.startsWith('file://')) {\n      normalised = new URL(descriptor)\n    }\n    let CustomClass = await FormatterBuilder.loadFile(normalised)\n    CustomClass = FormatterBuilder.resolveConstructor(CustomClass)\n    if (doesHaveValue(CustomClass)) {\n      return CustomClass\n    } else {\n      throw new Error(\n        `Custom ${type} (${descriptor}) does not export a function/class`\n      )\n    }\n  },\n\n  async loadFile(urlOrName: URL | string) {\n    let result\n    try {\n      // eslint-disable-next-line @typescript-eslint/no-var-requires\n      result = require(typeof urlOrName === 'string'\n        ? urlOrName\n        : fileURLToPath(urlOrName))\n    } catch (error) {\n      if (error.code === 'ERR_REQUIRE_ESM') {\n        result = await importer(urlOrName)\n      } else {\n        throw error\n      }\n    }\n    return result\n  },\n\n  resolveConstructor(ImportedCode: any) {\n    if (doesNotHaveValue(ImportedCode)) {\n      return null\n    }\n    if (typeof ImportedCode === 'function') {\n      return ImportedCode\n    } else if (\n      typeof ImportedCode === 'object' &&\n      typeof ImportedCode.default === 'function'\n    ) {\n      return ImportedCode.default\n    }\n    return null\n  },\n}\n\nexport default FormatterBuilder\n"],"mappings":"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"}
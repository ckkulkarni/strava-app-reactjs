{"version":3,"names":["messages_1","require","events_1","helpers_1","helpers_2","paths_1","runtime_1","formatters_1","support_1","environment_1","gherkin_1","plugins_1","console_logger_1","runCucumber","configuration","environment","onMessage","cwd","stdout","stderr","env","debug","mergeEnvironment","logger","ConsoleLogger","newId","IdGenerator","uuid","supportCoordinates","support","originalCoordinates","unexpandedFeaturePaths","featurePaths","requirePaths","importPaths","resolvePaths","sources","supportCodeLibrary","getSupportCodeLibrary","requireModules","plugins","initializePlugins","eventBroadcaster","EventEmitter","on","value","emit","eventDataCollector","EventDataCollector","formatterStreamError","cleanupFormatters","initializeFormatters","onStreamError","formats","emitMetaMessage","pickleIds","parseErrors","length","gherkinResult","getFilteredPicklesAndErrors","coordinates","onEnvelope","envelope","filteredPickles","map","pickle","id","forEach","parseError","error","source","uri","message","cleanup","success","emitSupportCodeMessages","runtime","makeRuntime","options","start","exports"],"sources":["../../src/api/run_cucumber.ts"],"sourcesContent":["import { Envelope, IdGenerator, ParseError } from '@cucumber/messages'\nimport { EventEmitter } from 'events'\nimport { EventDataCollector } from '../formatter/helpers'\nimport { emitMetaMessage, emitSupportCodeMessages } from '../cli/helpers'\nimport { IRunOptions, IRunEnvironment, IRunResult } from './types'\nimport { resolvePaths } from './paths'\nimport { makeRuntime } from './runtime'\nimport { initializeFormatters } from './formatters'\nimport { getSupportCodeLibrary } from './support'\nimport { mergeEnvironment } from './environment'\nimport { getFilteredPicklesAndErrors } from './gherkin'\nimport { initializePlugins } from './plugins'\nimport { ConsoleLogger } from './console_logger'\nimport { ILogger } from '../logger'\n\n/**\n * Execute a Cucumber test run.\n *\n * @public\n * @param configuration - Configuration loaded from `loadConfiguration`.\n * @param environment - Project environment.\n * @param onMessage - Callback fired each time Cucumber emits a message.\n */\nexport async function runCucumber(\n  configuration: IRunOptions,\n  environment: IRunEnvironment = {},\n  onMessage?: (message: Envelope) => void\n): Promise<IRunResult> {\n  const { cwd, stdout, stderr, env, debug } = mergeEnvironment(environment)\n  const logger: ILogger = new ConsoleLogger(stderr, debug)\n\n  const newId = IdGenerator.uuid()\n\n  const supportCoordinates =\n    'World' in configuration.support\n      ? configuration.support.originalCoordinates\n      : configuration.support\n\n  const { unexpandedFeaturePaths, featurePaths, requirePaths, importPaths } =\n    await resolvePaths(logger, cwd, configuration.sources, supportCoordinates)\n\n  const supportCodeLibrary =\n    'World' in configuration.support\n      ? configuration.support\n      : await getSupportCodeLibrary({\n          cwd,\n          newId,\n          requirePaths,\n          importPaths,\n          requireModules: supportCoordinates.requireModules,\n        })\n\n  const plugins = await initializePlugins(logger, configuration, environment)\n\n  const eventBroadcaster = new EventEmitter()\n  if (onMessage) {\n    eventBroadcaster.on('envelope', onMessage)\n  }\n  eventBroadcaster.on('envelope', (value) => plugins.emit('message', value))\n  const eventDataCollector = new EventDataCollector(eventBroadcaster)\n\n  let formatterStreamError = false\n  const cleanupFormatters = await initializeFormatters({\n    env,\n    cwd,\n    stdout,\n    stderr,\n    logger,\n    onStreamError: () => (formatterStreamError = true),\n    eventBroadcaster,\n    eventDataCollector,\n    configuration: configuration.formats,\n    supportCodeLibrary,\n  })\n  await emitMetaMessage(eventBroadcaster, env)\n\n  let pickleIds: string[] = []\n  let parseErrors: ParseError[] = []\n  if (featurePaths.length > 0) {\n    const gherkinResult = await getFilteredPicklesAndErrors({\n      newId,\n      cwd,\n      logger,\n      unexpandedFeaturePaths,\n      featurePaths,\n      coordinates: configuration.sources,\n      onEnvelope: (envelope) => eventBroadcaster.emit('envelope', envelope),\n    })\n    pickleIds = gherkinResult.filteredPickles.map(({ pickle }) => pickle.id)\n    parseErrors = gherkinResult.parseErrors\n  }\n  if (parseErrors.length) {\n    parseErrors.forEach((parseError) => {\n      logger.error(\n        `Parse error in \"${parseError.source.uri}\" ${parseError.message}`\n      )\n    })\n    await cleanupFormatters()\n    await plugins.cleanup()\n    return {\n      success: false,\n      support: supportCodeLibrary,\n    }\n  }\n\n  emitSupportCodeMessages({\n    eventBroadcaster,\n    supportCodeLibrary,\n    newId,\n  })\n\n  const runtime = makeRuntime({\n    cwd,\n    logger,\n    eventBroadcaster,\n    eventDataCollector,\n    pickleIds,\n    newId,\n    supportCodeLibrary,\n    requireModules: supportCoordinates.requireModules,\n    requirePaths,\n    importPaths,\n    options: configuration.runtime,\n  })\n  const success = await runtime.start()\n  await cleanupFormatters()\n  await plugins.cleanup()\n\n  return {\n    success: success && !formatterStreamError,\n    support: supportCodeLibrary,\n  }\n}\n"],"mappings":"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"}
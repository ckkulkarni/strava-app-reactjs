e6b487d1197cfc3788d6f50eaaafacff
"use strict";

var __importDefault = void 0 && (void 0).__importDefault || function (mod) {
  return mod && mod.__esModule ? mod : {
    "default": mod
  };
};
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.fromFile = void 0;
const string_argv_1 = __importDefault(require("string-argv"));
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const yaml_1 = __importDefault(require("yaml"));
const util_1 = require("util");
const url_1 = require("url");
const merge_configurations_1 = require("./merge_configurations");
const argv_parser_1 = __importDefault(require("./argv_parser"));
const check_schema_1 = require("./check_schema");
// eslint-disable-next-line @typescript-eslint/no-var-requires
const {
  importer
} = require('../importer');
async function fromFile(logger, cwd, file, profiles = []) {
  const definitions = await loadFile(cwd, file);
  if (!definitions.default) {
    logger.debug('No default profile defined in configuration file');
    definitions.default = {};
  }
  if (profiles.length < 1) {
    logger.debug('No profiles specified; using default profile');
    profiles = ['default'];
  }
  const definedKeys = Object.keys(definitions);
  profiles.forEach(profileKey => {
    if (!definedKeys.includes(profileKey)) {
      throw new Error(`Requested profile "${profileKey}" doesn't exist`);
    }
  });
  return (0, merge_configurations_1.mergeConfigurations)({}, ...profiles.map(profileKey => extractConfiguration(logger, profileKey, definitions[profileKey])));
}
exports.fromFile = fromFile;
async function loadFile(cwd, file) {
  const filePath = path_1.default.join(cwd, file);
  const extension = path_1.default.extname(filePath);
  let definitions;
  switch (extension) {
    case '.json':
      definitions = JSON.parse(await (0, util_1.promisify)(fs_1.default.readFile)(filePath, {
        encoding: 'utf-8'
      }));
      break;
    case '.yaml':
    case '.yml':
      definitions = yaml_1.default.parse(await (0, util_1.promisify)(fs_1.default.readFile)(filePath, {
        encoding: 'utf-8'
      }));
      break;
    default:
      try {
        // eslint-disable-next-line @typescript-eslint/no-var-requires
        definitions = require(filePath);
      } catch (error) {
        if (error.code === 'ERR_REQUIRE_ESM') {
          definitions = await importer((0, url_1.pathToFileURL)(filePath));
        } else {
          throw error;
        }
      }
  }
  if (typeof definitions !== 'object') {
    throw new Error(`Configuration file ${filePath} does not export an object`);
  }
  return definitions;
}
function extractConfiguration(logger, name, definition) {
  if (typeof definition === 'string') {
    logger.debug(`Profile "${name}" value is a string; parsing as argv`);
    const {
      configuration
    } = argv_parser_1.default.parse(['node', 'cucumber-js', ...(0, string_argv_1.default)(definition)]);
    return configuration;
  }
  try {
    return (0, check_schema_1.checkSchema)(definition);
  } catch (error) {
    throw new Error(`Requested profile "${name}" failed schema validation: ${error.errors.join(' ')}`);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJzdHJpbmdfYXJndl8xIiwiX19pbXBvcnREZWZhdWx0IiwicmVxdWlyZSIsImZzXzEiLCJwYXRoXzEiLCJ5YW1sXzEiLCJ1dGlsXzEiLCJ1cmxfMSIsIm1lcmdlX2NvbmZpZ3VyYXRpb25zXzEiLCJhcmd2X3BhcnNlcl8xIiwiY2hlY2tfc2NoZW1hXzEiLCJpbXBvcnRlciIsImZyb21GaWxlIiwibG9nZ2VyIiwiY3dkIiwiZmlsZSIsInByb2ZpbGVzIiwiZGVmaW5pdGlvbnMiLCJsb2FkRmlsZSIsImRlZmF1bHQiLCJkZWJ1ZyIsImxlbmd0aCIsImRlZmluZWRLZXlzIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJwcm9maWxlS2V5IiwiaW5jbHVkZXMiLCJFcnJvciIsIm1lcmdlQ29uZmlndXJhdGlvbnMiLCJtYXAiLCJleHRyYWN0Q29uZmlndXJhdGlvbiIsImV4cG9ydHMiLCJmaWxlUGF0aCIsImpvaW4iLCJleHRlbnNpb24iLCJleHRuYW1lIiwiSlNPTiIsInBhcnNlIiwicHJvbWlzaWZ5IiwicmVhZEZpbGUiLCJlbmNvZGluZyIsImVycm9yIiwiY29kZSIsInBhdGhUb0ZpbGVVUkwiLCJuYW1lIiwiZGVmaW5pdGlvbiIsImNvbmZpZ3VyYXRpb24iLCJjaGVja1NjaGVtYSIsImVycm9ycyJdLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb25maWd1cmF0aW9uL2Zyb21fZmlsZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgc3RyaW5nQXJndiBmcm9tICdzdHJpbmctYXJndidcbmltcG9ydCBmcyBmcm9tICdmcydcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgWUFNTCBmcm9tICd5YW1sJ1xuaW1wb3J0IHsgcHJvbWlzaWZ5IH0gZnJvbSAndXRpbCdcbmltcG9ydCB7IHBhdGhUb0ZpbGVVUkwgfSBmcm9tICd1cmwnXG5pbXBvcnQgeyBJQ29uZmlndXJhdGlvbiB9IGZyb20gJy4vdHlwZXMnXG5pbXBvcnQgeyBtZXJnZUNvbmZpZ3VyYXRpb25zIH0gZnJvbSAnLi9tZXJnZV9jb25maWd1cmF0aW9ucydcbmltcG9ydCBBcmd2UGFyc2VyIGZyb20gJy4vYXJndl9wYXJzZXInXG5pbXBvcnQgeyBjaGVja1NjaGVtYSB9IGZyb20gJy4vY2hlY2tfc2NoZW1hJ1xuaW1wb3J0IHsgSUxvZ2dlciB9IGZyb20gJy4uL2xvZ2dlcidcblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby12YXItcmVxdWlyZXNcbmNvbnN0IHsgaW1wb3J0ZXIgfSA9IHJlcXVpcmUoJy4uL2ltcG9ydGVyJylcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGZyb21GaWxlKFxuICBsb2dnZXI6IElMb2dnZXIsXG4gIGN3ZDogc3RyaW5nLFxuICBmaWxlOiBzdHJpbmcsXG4gIHByb2ZpbGVzOiBzdHJpbmdbXSA9IFtdXG4pOiBQcm9taXNlPFBhcnRpYWw8SUNvbmZpZ3VyYXRpb24+PiB7XG4gIGNvbnN0IGRlZmluaXRpb25zID0gYXdhaXQgbG9hZEZpbGUoY3dkLCBmaWxlKVxuICBpZiAoIWRlZmluaXRpb25zLmRlZmF1bHQpIHtcbiAgICBsb2dnZXIuZGVidWcoJ05vIGRlZmF1bHQgcHJvZmlsZSBkZWZpbmVkIGluIGNvbmZpZ3VyYXRpb24gZmlsZScpXG4gICAgZGVmaW5pdGlvbnMuZGVmYXVsdCA9IHt9XG4gIH1cbiAgaWYgKHByb2ZpbGVzLmxlbmd0aCA8IDEpIHtcbiAgICBsb2dnZXIuZGVidWcoJ05vIHByb2ZpbGVzIHNwZWNpZmllZDsgdXNpbmcgZGVmYXVsdCBwcm9maWxlJylcbiAgICBwcm9maWxlcyA9IFsnZGVmYXVsdCddXG4gIH1cbiAgY29uc3QgZGVmaW5lZEtleXMgPSBPYmplY3Qua2V5cyhkZWZpbml0aW9ucylcbiAgcHJvZmlsZXMuZm9yRWFjaCgocHJvZmlsZUtleSkgPT4ge1xuICAgIGlmICghZGVmaW5lZEtleXMuaW5jbHVkZXMocHJvZmlsZUtleSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgUmVxdWVzdGVkIHByb2ZpbGUgXCIke3Byb2ZpbGVLZXl9XCIgZG9lc24ndCBleGlzdGApXG4gICAgfVxuICB9KVxuICByZXR1cm4gbWVyZ2VDb25maWd1cmF0aW9ucyhcbiAgICB7fSxcbiAgICAuLi5wcm9maWxlcy5tYXAoKHByb2ZpbGVLZXkpID0+XG4gICAgICBleHRyYWN0Q29uZmlndXJhdGlvbihsb2dnZXIsIHByb2ZpbGVLZXksIGRlZmluaXRpb25zW3Byb2ZpbGVLZXldKVxuICAgIClcbiAgKVxufVxuXG5hc3luYyBmdW5jdGlvbiBsb2FkRmlsZShcbiAgY3dkOiBzdHJpbmcsXG4gIGZpbGU6IHN0cmluZ1xuKTogUHJvbWlzZTxSZWNvcmQ8c3RyaW5nLCBhbnk+PiB7XG4gIGNvbnN0IGZpbGVQYXRoOiBzdHJpbmcgPSBwYXRoLmpvaW4oY3dkLCBmaWxlKVxuICBjb25zdCBleHRlbnNpb24gPSBwYXRoLmV4dG5hbWUoZmlsZVBhdGgpXG4gIGxldCBkZWZpbml0aW9uc1xuICBzd2l0Y2ggKGV4dGVuc2lvbikge1xuICAgIGNhc2UgJy5qc29uJzpcbiAgICAgIGRlZmluaXRpb25zID0gSlNPTi5wYXJzZShcbiAgICAgICAgYXdhaXQgcHJvbWlzaWZ5KGZzLnJlYWRGaWxlKShmaWxlUGF0aCwgeyBlbmNvZGluZzogJ3V0Zi04JyB9KVxuICAgICAgKVxuICAgICAgYnJlYWtcbiAgICBjYXNlICcueWFtbCc6XG4gICAgY2FzZSAnLnltbCc6XG4gICAgICBkZWZpbml0aW9ucyA9IFlBTUwucGFyc2UoXG4gICAgICAgIGF3YWl0IHByb21pc2lmeShmcy5yZWFkRmlsZSkoZmlsZVBhdGgsIHsgZW5jb2Rpbmc6ICd1dGYtOCcgfSlcbiAgICAgIClcbiAgICAgIGJyZWFrXG4gICAgZGVmYXVsdDpcbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdmFyLXJlcXVpcmVzXG4gICAgICAgIGRlZmluaXRpb25zID0gcmVxdWlyZShmaWxlUGF0aClcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGlmIChlcnJvci5jb2RlID09PSAnRVJSX1JFUVVJUkVfRVNNJykge1xuICAgICAgICAgIGRlZmluaXRpb25zID0gYXdhaXQgaW1wb3J0ZXIocGF0aFRvRmlsZVVSTChmaWxlUGF0aCkpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgZXJyb3JcbiAgICAgICAgfVxuICAgICAgfVxuICB9XG4gIGlmICh0eXBlb2YgZGVmaW5pdGlvbnMgIT09ICdvYmplY3QnKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDb25maWd1cmF0aW9uIGZpbGUgJHtmaWxlUGF0aH0gZG9lcyBub3QgZXhwb3J0IGFuIG9iamVjdGApXG4gIH1cbiAgcmV0dXJuIGRlZmluaXRpb25zXG59XG5cbmZ1bmN0aW9uIGV4dHJhY3RDb25maWd1cmF0aW9uKFxuICBsb2dnZXI6IElMb2dnZXIsXG4gIG5hbWU6IHN0cmluZyxcbiAgZGVmaW5pdGlvbjogYW55XG4pOiBQYXJ0aWFsPElDb25maWd1cmF0aW9uPiB7XG4gIGlmICh0eXBlb2YgZGVmaW5pdGlvbiA9PT0gJ3N0cmluZycpIHtcbiAgICBsb2dnZXIuZGVidWcoYFByb2ZpbGUgXCIke25hbWV9XCIgdmFsdWUgaXMgYSBzdHJpbmc7IHBhcnNpbmcgYXMgYXJndmApXG4gICAgY29uc3QgeyBjb25maWd1cmF0aW9uIH0gPSBBcmd2UGFyc2VyLnBhcnNlKFtcbiAgICAgICdub2RlJyxcbiAgICAgICdjdWN1bWJlci1qcycsXG4gICAgICAuLi5zdHJpbmdBcmd2KGRlZmluaXRpb24pLFxuICAgIF0pXG4gICAgcmV0dXJuIGNvbmZpZ3VyYXRpb25cbiAgfVxuICB0cnkge1xuICAgIHJldHVybiBjaGVja1NjaGVtYShkZWZpbml0aW9uKVxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBSZXF1ZXN0ZWQgcHJvZmlsZSBcIiR7bmFtZX1cIiBmYWlsZWQgc2NoZW1hIHZhbGlkYXRpb246ICR7ZXJyb3IuZXJyb3JzLmpvaW4oXG4gICAgICAgICcgJ1xuICAgICAgKX1gXG4gICAgKVxuICB9XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUEsTUFBQUEsYUFBQSxHQUFBQyxlQUFBLENBQUFDLE9BQUE7QUFDQSxNQUFBQyxJQUFBLEdBQUFGLGVBQUEsQ0FBQUMsT0FBQTtBQUNBLE1BQUFFLE1BQUEsR0FBQUgsZUFBQSxDQUFBQyxPQUFBO0FBQ0EsTUFBQUcsTUFBQSxHQUFBSixlQUFBLENBQUFDLE9BQUE7QUFDQSxNQUFBSSxNQUFBLEdBQUFKLE9BQUE7QUFDQSxNQUFBSyxLQUFBLEdBQUFMLE9BQUE7QUFFQSxNQUFBTSxzQkFBQSxHQUFBTixPQUFBO0FBQ0EsTUFBQU8sYUFBQSxHQUFBUixlQUFBLENBQUFDLE9BQUE7QUFDQSxNQUFBUSxjQUFBLEdBQUFSLE9BQUE7QUFHQTtBQUNBLE1BQU07RUFBRVM7QUFBUSxDQUFFLEdBQUdULE9BQU8sQ0FBQyxhQUFhLENBQUM7QUFFcEMsZUFBZVUsUUFBUUEsQ0FDNUJDLE1BQWUsRUFDZkMsR0FBVyxFQUNYQyxJQUFZLEVBQ1pDLFFBQUEsR0FBcUIsRUFBRTtFQUV2QixNQUFNQyxXQUFXLEdBQUcsTUFBTUMsUUFBUSxDQUFDSixHQUFHLEVBQUVDLElBQUksQ0FBQztFQUM3QyxJQUFJLENBQUNFLFdBQVcsQ0FBQ0UsT0FBTyxFQUFFO0lBQ3hCTixNQUFNLENBQUNPLEtBQUssQ0FBQyxrREFBa0QsQ0FBQztJQUNoRUgsV0FBVyxDQUFDRSxPQUFPLEdBQUcsRUFBRTs7RUFFMUIsSUFBSUgsUUFBUSxDQUFDSyxNQUFNLEdBQUcsQ0FBQyxFQUFFO0lBQ3ZCUixNQUFNLENBQUNPLEtBQUssQ0FBQyw4Q0FBOEMsQ0FBQztJQUM1REosUUFBUSxHQUFHLENBQUMsU0FBUyxDQUFDOztFQUV4QixNQUFNTSxXQUFXLEdBQUdDLE1BQU0sQ0FBQ0MsSUFBSSxDQUFDUCxXQUFXLENBQUM7RUFDNUNELFFBQVEsQ0FBQ1MsT0FBTyxDQUFF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
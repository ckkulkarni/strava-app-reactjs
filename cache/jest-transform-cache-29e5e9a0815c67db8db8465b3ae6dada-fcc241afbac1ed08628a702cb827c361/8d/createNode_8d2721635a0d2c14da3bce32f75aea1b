ea85d9b8eae10f93d75c1fb9b5af69b5
'use strict';

var Alias = require('../nodes/Alias.js');
var Node = require('../nodes/Node.js');
var Scalar = require('../nodes/Scalar.js');
const defaultTagPrefix = 'tag:yaml.org,2002:';
function findTagObject(value, tagName, tags) {
  if (tagName) {
    const match = tags.filter(t => t.tag === tagName);
    const tagObj = match.find(t => !t.format) ?? match[0];
    if (!tagObj) throw new Error(`Tag ${tagName} not found`);
    return tagObj;
  }
  return tags.find(t => t.identify?.(value) && !t.format);
}
function createNode(value, tagName, ctx) {
  if (Node.isDocument(value)) value = value.contents;
  if (Node.isNode(value)) return value;
  if (Node.isPair(value)) {
    const map = ctx.schema[Node.MAP].createNode?.(ctx.schema, null, ctx);
    map.items.push(value);
    return map;
  }
  if (value instanceof String || value instanceof Number || value instanceof Boolean || typeof BigInt !== 'undefined' && value instanceof BigInt // not supported everywhere
  ) {
    // https://tc39.es/ecma262/#sec-serializejsonproperty
    value = value.valueOf();
  }
  const {
    aliasDuplicateObjects,
    onAnchor,
    onTagObj,
    schema,
    sourceObjects
  } = ctx;
  // Detect duplicate references to the same object & use Alias nodes for all
  // after first. The `ref` wrapper allows for circular references to resolve.
  let ref = undefined;
  if (aliasDuplicateObjects && value && typeof value === 'object') {
    ref = sourceObjects.get(value);
    if (ref) {
      if (!ref.anchor) ref.anchor = onAnchor(value);
      return new Alias.Alias(ref.anchor);
    } else {
      ref = {
        anchor: null,
        node: null
      };
      sourceObjects.set(value, ref);
    }
  }
  if (tagName?.startsWith('!!')) tagName = defaultTagPrefix + tagName.slice(2);
  let tagObj = findTagObject(value, tagName, schema.tags);
  if (!tagObj) {
    if (value && typeof value.toJSON === 'function') {
      // eslint-disable-next-line @typescript-eslint/no-unsafe-call
      value = value.toJSON();
    }
    if (!value || typeof value !== 'object') {
      const node = new Scalar.Scalar(value);
      if (ref) ref.node = node;
      return node;
    }
    tagObj = value instanceof Map ? schema[Node.MAP] : Symbol.iterator in Object(value) ? schema[Node.SEQ] : schema[Node.MAP];
  }
  if (onTagObj) {
    onTagObj(tagObj);
    delete ctx.onTagObj;
  }
  const node = tagObj?.createNode ? tagObj.createNode(ctx.schema, value, ctx) : new Scalar.Scalar(value);
  if (tagName) node.tag = tagName;
  if (ref) ref.node = node;
  return node;
}
exports.createNode = createNode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJBbGlhcyIsInJlcXVpcmUiLCJOb2RlIiwiU2NhbGFyIiwiZGVmYXVsdFRhZ1ByZWZpeCIsImZpbmRUYWdPYmplY3QiLCJ2YWx1ZSIsInRhZ05hbWUiLCJ0YWdzIiwibWF0Y2giLCJmaWx0ZXIiLCJ0IiwidGFnIiwidGFnT2JqIiwiZmluZCIsImZvcm1hdCIsIkVycm9yIiwiaWRlbnRpZnkiLCJjcmVhdGVOb2RlIiwiY3R4IiwiaXNEb2N1bWVudCIsImNvbnRlbnRzIiwiaXNOb2RlIiwiaXNQYWlyIiwibWFwIiwic2NoZW1hIiwiTUFQIiwiaXRlbXMiLCJwdXNoIiwiU3RyaW5nIiwiTnVtYmVyIiwiQm9vbGVhbiIsIkJpZ0ludCIsInZhbHVlT2YiLCJhbGlhc0R1cGxpY2F0ZU9iamVjdHMiLCJvbkFuY2hvciIsIm9uVGFnT2JqIiwic291cmNlT2JqZWN0cyIsInJlZiIsInVuZGVmaW5lZCIsImdldCIsImFuY2hvciIsIm5vZGUiLCJzZXQiLCJzdGFydHNXaXRoIiwic2xpY2UiLCJ0b0pTT04iLCJNYXAiLCJTeW1ib2wiLCJpdGVyYXRvciIsIk9iamVjdCIsIlNFUSIsImV4cG9ydHMiXSwic291cmNlcyI6WyJjcmVhdGVOb2RlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxudmFyIEFsaWFzID0gcmVxdWlyZSgnLi4vbm9kZXMvQWxpYXMuanMnKTtcbnZhciBOb2RlID0gcmVxdWlyZSgnLi4vbm9kZXMvTm9kZS5qcycpO1xudmFyIFNjYWxhciA9IHJlcXVpcmUoJy4uL25vZGVzL1NjYWxhci5qcycpO1xuXG5jb25zdCBkZWZhdWx0VGFnUHJlZml4ID0gJ3RhZzp5YW1sLm9yZywyMDAyOic7XG5mdW5jdGlvbiBmaW5kVGFnT2JqZWN0KHZhbHVlLCB0YWdOYW1lLCB0YWdzKSB7XG4gICAgaWYgKHRhZ05hbWUpIHtcbiAgICAgICAgY29uc3QgbWF0Y2ggPSB0YWdzLmZpbHRlcih0ID0+IHQudGFnID09PSB0YWdOYW1lKTtcbiAgICAgICAgY29uc3QgdGFnT2JqID0gbWF0Y2guZmluZCh0ID0+ICF0LmZvcm1hdCkgPz8gbWF0Y2hbMF07XG4gICAgICAgIGlmICghdGFnT2JqKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUYWcgJHt0YWdOYW1lfSBub3QgZm91bmRgKTtcbiAgICAgICAgcmV0dXJuIHRhZ09iajtcbiAgICB9XG4gICAgcmV0dXJuIHRhZ3MuZmluZCh0ID0+IHQuaWRlbnRpZnk/Lih2YWx1ZSkgJiYgIXQuZm9ybWF0KTtcbn1cbmZ1bmN0aW9uIGNyZWF0ZU5vZGUodmFsdWUsIHRhZ05hbWUsIGN0eCkge1xuICAgIGlmIChOb2RlLmlzRG9jdW1lbnQodmFsdWUpKVxuICAgICAgICB2YWx1ZSA9IHZhbHVlLmNvbnRlbnRzO1xuICAgIGlmIChOb2RlLmlzTm9kZSh2YWx1ZSkpXG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICBpZiAoTm9kZS5pc1BhaXIodmFsdWUpKSB7XG4gICAgICAgIGNvbnN0IG1hcCA9IGN0eC5zY2hlbWFbTm9kZS5NQVBdLmNyZWF0ZU5vZGU/LihjdHguc2NoZW1hLCBudWxsLCBjdHgpO1xuICAgICAgICBtYXAuaXRlbXMucHVzaCh2YWx1ZSk7XG4gICAgICAgIHJldHVybiBtYXA7XG4gICAgfVxuICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFN0cmluZyB8fFxuICAgICAgICB2YWx1ZSBpbnN0YW5jZW9mIE51bWJlciB8fFxuICAgICAgICB2YWx1ZSBpbnN0YW5jZW9mIEJvb2xlYW4gfHxcbiAgICAgICAgKHR5cGVvZiBCaWdJbnQgIT09ICd1bmRlZmluZWQnICYmIHZhbHVlIGluc3RhbmNlb2YgQmlnSW50KSAvLyBub3Qgc3VwcG9ydGVkIGV2ZXJ5d2hlcmVcbiAgICApIHtcbiAgICAgICAgLy8gaHR0cHM6Ly90YzM5LmVzL2VjbWEyNjIvI3NlYy1zZXJpYWxpemVqc29ucHJvcGVydHlcbiAgICAgICAgdmFsdWUgPSB2YWx1ZS52YWx1ZU9mKCk7XG4gICAgfVxuICAgIGNvbnN0IHsgYWxpYXNEdXBsaWNhdGVPYmplY3RzLCBvbkFuY2hvciwgb25UYWdPYmosIHNjaGVtYSwgc291cmNlT2JqZWN0cyB9ID0gY3R4O1xuICAgIC8vIERldGVjdCBkdXBsaWNhdGUgcmVmZXJlbmNlcyB0byB0aGUgc2FtZSBvYmplY3QgJiB1c2UgQWxpYXMgbm9kZXMgZm9yIGFsbFxuICAgIC8vIGFmdGVyIGZpcnN0LiBUaGUgYHJlZmAgd3JhcHBlciBhbGxvd3MgZm9yIGNpcmN1bGFyIHJlZmVyZW5jZXMgdG8gcmVzb2x2ZS5cbiAgICBsZXQgcmVmID0gdW5kZWZpbmVkO1xuICAgIGlmIChhbGlhc0R1cGxpY2F0ZU9iamVjdHMgJiYgdmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0Jykge1xuICAgICAgICByZWYgPSBzb3VyY2VPYmplY3RzLmdldCh2YWx1ZSk7XG4gICAgICAgIGlmIChyZWYpIHtcbiAgICAgICAgICAgIGlmICghcmVmLmFuY2hvcilcbiAgICAgICAgICAgICAgICByZWYuYW5jaG9yID0gb25BbmNob3IodmFsdWUpO1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBBbGlhcy5BbGlhcyhyZWYuYW5jaG9yKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHJlZiA9IHsgYW5jaG9yOiBudWxsLCBub2RlOiBudWxsIH07XG4gICAgICAgICAgICBzb3VyY2VPYmplY3RzLnNldCh2YWx1ZSwgcmVmKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAodGFnTmFtZT8uc3RhcnRzV2l0aCgnISEnKSlcbiAgICAgICAgdGFnTmFtZSA9IGRlZmF1bHRUYWdQcmVmaXggKyB0YWdOYW1lLnNsaWNlKDIpO1xuICAgIGxldCB0YWdPYmogPSBmaW5kVGFnT2JqZWN0KHZhbHVlLCB0YWdOYW1lLCBzY2hlbWEudGFncyk7XG4gICAgaWYgKCF0YWdPYmopIHtcbiAgICAgICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZS50b0pTT04gPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW5zYWZlLWNhbGxcbiAgICAgICAgICAgIHZhbHVlID0gdmFsdWUudG9KU09OKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF2YWx1ZSB8fCB0eXBlb2YgdmFsdWUgIT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICBjb25zdCBub2RlID0gbmV3IFNjYWxhci5TY2FsYXIodmFsdWUpO1xuICAgICAgICAgICAgaWYgKHJlZilcbiAgICAgICAgICAgICAgICByZWYubm9kZSA9IG5vZGU7XG4gICAgICAgICAgICByZXR1cm4gbm9kZTtcbiAgICAgICAgfVxuICAgICAgICB0YWdPYmogPVxuICAgICAgICAgICAgdmFsdWUgaW5zdGFuY2VvZiBNYXBcbiAgICAgICAgICAgICAgICA/IHNjaGVtYVtOb2RlLk1BUF1cbiAgICAgICAgICAgICAgICA6IFN5bWJvbC5pdGVyYXRvciBpbiBPYmplY3QodmFsdWUpXG4gICAgICAgICAgICAgICAgICAgID8gc2NoZW1hW05vZGUuU0VRXVxuICAgICAgICAgICAgICAgICAgICA6IHNjaGVtYVtOb2RlLk1BUF07XG4gICAgfVxuICAgIGlmIChvblRhZ09iaikge1xuICAgICAgICBvblRhZ09iaih0YWdPYmopO1xuICAgICAgICBkZWxldGUgY3R4Lm9uVGFnT2JqO1xuICAgIH1cbiAgICBjb25zdCBub2RlID0gdGFnT2JqPy5jcmVhdGVOb2RlXG4gICAgICAgID8gdGFnT2JqLmNyZWF0ZU5vZGUoY3R4LnNjaGVtYSwgdmFsdWUsIGN0eClcbiAgICAgICAgOiBuZXcgU2NhbGFyLlNjYWxhcih2YWx1ZSk7XG4gICAgaWYgKHRhZ05hbWUpXG4gICAgICAgIG5vZGUudGFnID0gdGFnTmFtZTtcbiAgICBpZiAocmVmKVxuICAgICAgICByZWYubm9kZSA9IG5vZGU7XG4gICAgcmV0dXJuIG5vZGU7XG59XG5cbmV4cG9ydHMuY3JlYXRlTm9kZSA9IGNyZWF0ZU5vZGU7XG4iXSwibWFw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
{"version":3,"names":["util_1","require","glob_1","__importDefault","path_1","fs_1","resolvePaths","logger","cwd","sources","support","requireModules","requirePaths","importPaths","unexpandedFeaturePaths","getUnexpandedFeaturePaths","paths","featurePaths","expandFeaturePaths","debug","deriveSupportPaths","exports","expandPaths","unexpandedPaths","defaultExtension","expandedPaths","Promise","all","map","unexpandedPath","matches","promisify","default","absolute","expanded","match","extname","flat","normalized","x","normalize","Set","args","length","nestedFeaturePaths","arg","filename","basename","filePath","join","content","readFile","split","trim","filter","getFeatureDirectoryPaths","featureDirs","featurePath","featureDir","dirname","childDir","parentDir","relative","p","replace","unexpandedRequirePaths","unexpandedImportPaths","defaultPaths"],"sources":["../../src/api/paths.ts"],"sourcesContent":["import { promisify } from 'util'\nimport glob from 'glob'\nimport path from 'path'\nimport fs from 'mz/fs'\nimport { ISourcesCoordinates, ISupportCodeCoordinates } from './types'\nimport { ILogger } from '../logger'\n\nexport async function resolvePaths(\n  logger: ILogger,\n  cwd: string,\n  sources: Pick<ISourcesCoordinates, 'paths'>,\n  support: ISupportCodeCoordinates = {\n    requireModules: [],\n    requirePaths: [],\n    importPaths: [],\n  }\n): Promise<{\n  unexpandedFeaturePaths: string[]\n  featurePaths: string[]\n  requirePaths: string[]\n  importPaths: string[]\n}> {\n  const unexpandedFeaturePaths = await getUnexpandedFeaturePaths(\n    cwd,\n    sources.paths\n  )\n  const featurePaths: string[] = await expandFeaturePaths(\n    cwd,\n    unexpandedFeaturePaths\n  )\n  logger.debug('Found feature files based on configuration:', featurePaths)\n  const { requirePaths, importPaths } = await deriveSupportPaths(\n    cwd,\n    featurePaths,\n    support.requirePaths,\n    support.importPaths\n  )\n  logger.debug(\n    'Found support files to load via `require` based on configuration:',\n    requirePaths\n  )\n  logger.debug(\n    'Found support files to load via `import` based on configuration:',\n    importPaths\n  )\n  return {\n    unexpandedFeaturePaths,\n    featurePaths,\n    requirePaths,\n    importPaths,\n  }\n}\n\nasync function expandPaths(\n  cwd: string,\n  unexpandedPaths: string[],\n  defaultExtension: string\n): Promise<string[]> {\n  const expandedPaths = await Promise.all(\n    unexpandedPaths.map(async (unexpandedPath) => {\n      const matches = await promisify(glob)(unexpandedPath, {\n        absolute: true,\n        cwd,\n      })\n      const expanded = await Promise.all(\n        matches.map(async (match) => {\n          if (path.extname(match) === '') {\n            return await promisify(glob)(`${match}/**/*${defaultExtension}`)\n          }\n          return [match]\n        })\n      )\n      return expanded.flat()\n    })\n  )\n  const normalized = expandedPaths.flat().map((x) => path.normalize(x))\n  return [...new Set(normalized)]\n}\n\nasync function getUnexpandedFeaturePaths(\n  cwd: string,\n  args: string[]\n): Promise<string[]> {\n  if (args.length > 0) {\n    const nestedFeaturePaths = await Promise.all(\n      args.map(async (arg) => {\n        const filename = path.basename(arg)\n        if (filename[0] === '@') {\n          const filePath = path.join(cwd, arg)\n          const content = await fs.readFile(filePath, 'utf8')\n          return content.split('\\n').map((x) => x.trim())\n        }\n        return [arg]\n      })\n    )\n    const featurePaths = nestedFeaturePaths.flat()\n    if (featurePaths.length > 0) {\n      return featurePaths.filter((x) => x !== '')\n    }\n  }\n  return ['features/**/*.{feature,feature.md}']\n}\n\nfunction getFeatureDirectoryPaths(\n  cwd: string,\n  featurePaths: string[]\n): string[] {\n  const featureDirs = featurePaths.map((featurePath) => {\n    let featureDir = path.dirname(featurePath)\n    let childDir: string\n    let parentDir = featureDir\n    while (childDir !== parentDir) {\n      childDir = parentDir\n      parentDir = path.dirname(childDir)\n      if (path.basename(parentDir) === 'features') {\n        featureDir = parentDir\n        break\n      }\n    }\n    return path.relative(cwd, featureDir)\n  })\n  return [...new Set(featureDirs)]\n}\n\nasync function expandFeaturePaths(\n  cwd: string,\n  featurePaths: string[]\n): Promise<string[]> {\n  featurePaths = featurePaths.map((p) => p.replace(/(:\\d+)*$/g, '')) // Strip line numbers\n  return await expandPaths(cwd, featurePaths, '.feature')\n}\n\nasync function deriveSupportPaths(\n  cwd: string,\n  featurePaths: string[],\n  unexpandedRequirePaths: string[],\n  unexpandedImportPaths: string[]\n): Promise<{\n  requirePaths: string[]\n  importPaths: string[]\n}> {\n  if (\n    unexpandedRequirePaths.length === 0 &&\n    unexpandedImportPaths.length === 0\n  ) {\n    const defaultPaths = getFeatureDirectoryPaths(cwd, featurePaths)\n    const requirePaths = await expandPaths(cwd, defaultPaths, '.js')\n    const importPaths = await expandPaths(cwd, defaultPaths, '.mjs')\n    return { requirePaths, importPaths }\n  }\n  const requirePaths =\n    unexpandedRequirePaths.length > 0\n      ? await expandPaths(cwd, unexpandedRequirePaths, '.js')\n      : []\n  const importPaths =\n    unexpandedImportPaths.length > 0\n      ? await expandPaths(cwd, unexpandedImportPaths, '.@(js|cjs|mjs)')\n      : []\n  return { requirePaths, importPaths }\n}\n"],"mappings":";;;;;;;;;;;AAAA,MAAAA,MAAA,GAAAC,OAAA;AACA,MAAAC,MAAA,GAAAC,eAAA,CAAAF,OAAA;AACA,MAAAG,MAAA,GAAAD,eAAA,CAAAF,OAAA;AACA,MAAAI,IAAA,GAAAF,eAAA,CAAAF,OAAA;AAIO,eAAeK,YAAYA,CAChCC,MAAe,EACfC,GAAW,EACXC,OAA2C,EAC3CC,OAAA,GAAmC;EACjCC,cAAc,EAAE,EAAE;EAClBC,YAAY,EAAE,EAAE;EAChBC,WAAW,EAAE;CACd;EAOD,MAAMC,sBAAsB,GAAG,MAAMC,yBAAyB,CAC5DP,GAAG,EACHC,OAAO,CAACO,KAAK,CACd;EACD,MAAMC,YAAY,GAAa,MAAMC,kBAAkB,CACrDV,GAAG,EACHM,sBAAsB,CACvB;EACDP,MAAM,CAACY,KAAK,CAAC,6CAA6C,EAAEF,YAAY,CAAC;EACzE,MAAM;IAAEL,YAAY;IAAEC;EAAW,CAAE,GAAG,MAAMO,kBAAkB,CAC5DZ,GAAG,EACHS,YAAY,EACZP,OAAO,CAACE,YAAY,EACpBF,OAAO,CAACG,WAAW,CACpB;EACDN,MAAM,CAACY,KAAK,CACV,mEAAmE,EACnEP,YAAY,CACb;EACDL,MAAM,CAACY,KAAK,CACV,kEAAkE,EAClEN,WAAW,CACZ;EACD,OAAO;IACLC,sBAAsB;IACtBG,YAAY;IACZL,YAAY;IACZC;GACD;AACH;AA5CAQ,OAAA,CAAAf,YAAA,GAAAA,YAAA;AA8CA,eAAegB,WAAWA,CACxBd,GAAW,EACXe,eAAyB,EACzBC,gBAAwB;EAExB,MAAMC,aAAa,GAAG,MAAMC,OAAO,CAACC,GAAG,CACrCJ,eAAe,CAACK,GAAG,CAAC,MAAOC,cAAc,IAAI;IAC3C,MAAMC,OAAO,GAAG,MAAM,IAAA9B,MAAA,CAAA+B,SAAS,EAAC7B,MAAA,CAAA8B,OAAI,CAAC,CAACH,cAAc,EAAE;MACpDI,QAAQ,EAAE,IAAI;MACdzB;KACD,CAAC;IACF,MAAM0B,QAAQ,GAAG,MAAMR,OAAO,CAACC,GAAG,CAChCG,OAAO,CAACF,GAAG,CAAC,MAAOO,KAAK,IAAI;MAC1B,IAAI/B,MAAA,CAAA4B,OAAI,CAACI,OAAO,CAACD,KAAK,CAAC,KAAK,EAAE,EAAE;QAC9B,OAAO,MAAM,IAAAnC,MAAA,CAAA+B,SAAS,EAAC7B,MAAA,CAAA8B,OAAI,CAAC,CAAC,GAAGG,KAAK,QAAQX,gBAAgB,EAAE,CAAC;;MAElE,OAAO,CAACW,KAAK,CAAC;IAChB,CAAC,CAAC,CACH;IACD,OAAOD,QAAQ,CAACG,IAAI,EAAE;EACxB,CAAC,CAAC,CACH;EACD,MAAMC,UAAU,GAAGb,aAAa,CAACY,IAAI,EAAE,CAACT,GAAG,CAAEW,CAAC,IAAKnC,MAAA,CAAA4B,OAAI,CAACQ,SAAS,CAACD,CAAC,CAAC,CAAC;EACrE,OAAO,CAAC,GAAG,IAAIE,GAAG,CAACH,UAAU,CAAC,CAAC;AACjC;AAEA,eAAevB,yBAAyBA,CACtCP,GAAW,EACXkC,IAAc;EAEd,IAAIA,IAAI,CAACC,MAAM,GAAG,CAAC,EAAE;IACnB,MAAMC,kBAAkB,GAAG,MAAMlB,OAAO,CAACC,GAAG,CAC1Ce,IAAI,CAACd,GAAG,CAAC,MAAOiB,GAAG,IAAI;MACrB,MAAMC,QAAQ,GAAG1C,MAAA,CAAA4B,OAAI,CAACe,QAAQ,CAACF,GAAG,CAAC;MACnC,IAAIC,QAAQ,CAAC,CAAC,CAAC,KAAK,GAAG,EAAE;QACvB,MAAME,QAAQ,GAAG5C,MAAA,CAAA4B,OAAI,CAACiB,IAAI,CAACzC,GAAG,EAAEqC,GAAG,CAAC;QACpC,MAAMK,OAAO,GAAG,MAAM7C,IAAA,CAAA2B,OAAE,CAACmB,QAAQ,CAACH,QAAQ,EAAE,MAAM,CAAC;QACnD,OAAOE,OAAO,CAACE,KAAK,CAAC,IAAI,CAAC,CAACxB,GAAG,CAAEW,CAAC,IAAKA,CAAC,CAACc,IAAI,EAAE,CAAC;;MAEjD,OAAO,CAACR,GAAG,CAAC;IACd,CAAC,CAAC,CACH;IACD,MAAM5B,YAAY,GAAG2B,kBAAkB,CAACP,IAAI,EAAE;IAC9C,IAAIpB,YAAY,CAAC0B,MAAM,GAAG,CAAC,EAAE;MAC3B,OAAO1B,YAAY,CAACqC,MAAM,CAAEf,CAAC,IAAKA,CAAC,KAAK,EAAE,CAAC;;;EAG/C,OAAO,CAAC,oCAAoC,CAAC;AAC/C;AAEA,SAASgB,wBAAwBA,CAC/B/C,GAAW,EACXS,YAAsB;EAEtB,MAAMuC,WAAW,GAAGvC,YAAY,CAACW,GAAG,CAAE6B,WAAW,IAAI;IACnD,IAAIC,UAAU,GAAGtD,MAAA,CAAA4B,OAAI,CAAC2B,OAAO,CAACF,WAAW,CAAC;IAC1C,IAAIG,QAAgB;IACpB,IAAIC,SAAS,GAAGH,UAAU;IAC1B,OAAOE,QAAQ,KAAKC,SAAS,EAAE;MAC7BD,QAAQ,GAAGC,SAAS;MACpBA,SAAS,GAAGzD,MAAA,CAAA4B,OAAI,CAAC2B,OAAO,CAACC,QAAQ,CAAC;MAClC,IAAIxD,MAAA,CAAA4B,OAAI,CAACe,QAAQ,CAACc,SAAS,CAAC,KAAK,UAAU,EAAE;QAC3CH,UAAU,GAAGG,SAAS;QACtB;;;IAGJ,OAAOzD,MAAA,CAAA4B,OAAI,CAAC8B,QAAQ,CAACtD,GAAG,EAAEkD,UAAU,CAAC;EACvC,CAAC,CAAC;EACF,OAAO,CAAC,GAAG,IAAIjB,GAAG,CAACe,WAAW,CAAC,CAAC;AAClC;AAEA,eAAetC,kBAAkBA,CAC/BV,GAAW,EACXS,YAAsB;EAEtBA,YAAY,GAAGA,YAAY,CAACW,GAAG,CAAEmC,CAAC,IAAKA,CAAC,CAACC,OAAO,CAAC,WAAW,EAAE,EAAE,CAAC,CAAC,EAAC;EACnE,OAAO,MAAM1C,WAAW,CAACd,GAAG,EAAES,YAAY,EAAE,UAAU,CAAC;AACzD;AAEA,eAAeG,kBAAkBA,CAC/BZ,GAAW,EACXS,YAAsB,EACtBgD,sBAAgC,EAChCC,qBAA+B;EAK/B,IACED,sBAAsB,CAACtB,MAAM,KAAK,CAAC,IACnCuB,qBAAqB,CAACvB,MAAM,KAAK,CAAC,EAClC;IACA,MAAMwB,YAAY,GAAGZ,wBAAwB,CAAC/C,GAAG,EAAES,YAAY,CAAC;IAChE,MAAML,YAAY,GAAG,MAAMU,WAAW,CAACd,GAAG,EAAE2D,YAAY,EAAE,KAAK,CAAC;IAChE,MAAMtD,WAAW,GAAG,MAAMS,WAAW,CAACd,GAAG,EAAE2D,YAAY,EAAE,MAAM,CAAC;IAChE,OAAO;MAAEvD,YAAY;MAAEC;IAAW,CAAE;;EAEtC,MAAMD,YAAY,GAChBqD,sBAAsB,CAACtB,MAAM,GAAG,CAAC,GAC7B,MAAMrB,WAAW,CAACd,GAAG,EAAEyD,sBAAsB,EAAE,KAAK,CAAC,GACrD,EAAE;EACR,MAAMpD,WAAW,GACfqD,qBAAqB,CAACvB,MAAM,GAAG,CAAC,GAC5B,MAAMrB,WAAW,CAACd,GAAG,EAAE0D,qBAAqB,EAAE,gBAAgB,CAAC,GAC/D,EAAE;EACR,OAAO;IAAEtD,YAAY;IAAEC;EAAW,CAAE;AACtC"}
{"version":3,"names":["_line","require","structuredPatch","oldFileName","newFileName","oldStr","newStr","oldHeader","newHeader","options","context","diff","diffLines","push","value","lines","contextLines","map","entry","hunks","oldRangeStart","newRangeStart","curRange","oldLine","newLine","_loop","i","current","replace","split","added","removed","_curRange","prev","slice","length","apply","_toConsumableArray","_curRange2","_curRange3","contextSize","Math","min","hunk","oldStart","oldLines","newStart","newLines","oldEOFNewline","test","newEOFNewline","noNlBeforeAdds","splice","createTwoFilesPatch","ret","join","createPatch","fileName"],"sources":["../../src/patch/create.js"],"sourcesContent":["import {diffLines} from '../diff/line';\n\nexport function structuredPatch(oldFileName, newFileName, oldStr, newStr, oldHeader, newHeader, options) {\n  if (!options) {\n    options = {};\n  }\n  if (typeof options.context === 'undefined') {\n    options.context = 4;\n  }\n\n  const diff = diffLines(oldStr, newStr, options);\n  diff.push({value: '', lines: []}); // Append an empty value to make cleanup easier\n\n  function contextLines(lines) {\n    return lines.map(function(entry) { return ' ' + entry; });\n  }\n\n  let hunks = [];\n  let oldRangeStart = 0, newRangeStart = 0, curRange = [],\n      oldLine = 1, newLine = 1;\n  for (let i = 0; i < diff.length; i++) {\n    const current = diff[i],\n          lines = current.lines || current.value.replace(/\\n$/, '').split('\\n');\n    current.lines = lines;\n\n    if (current.added || current.removed) {\n      // If we have previous context, start with that\n      if (!oldRangeStart) {\n        const prev = diff[i - 1];\n        oldRangeStart = oldLine;\n        newRangeStart = newLine;\n\n        if (prev) {\n          curRange = options.context > 0 ? contextLines(prev.lines.slice(-options.context)) : [];\n          oldRangeStart -= curRange.length;\n          newRangeStart -= curRange.length;\n        }\n      }\n\n      // Output our changes\n      curRange.push(... lines.map(function(entry) {\n        return (current.added ? '+' : '-') + entry;\n      }));\n\n      // Track the updated file position\n      if (current.added) {\n        newLine += lines.length;\n      } else {\n        oldLine += lines.length;\n      }\n    } else {\n      // Identical context lines. Track line changes\n      if (oldRangeStart) {\n        // Close out any changes that have been output (or join overlapping)\n        if (lines.length <= options.context * 2 && i < diff.length - 2) {\n          // Overlapping\n          curRange.push(... contextLines(lines));\n        } else {\n          // end the range and output\n          let contextSize = Math.min(lines.length, options.context);\n          curRange.push(... contextLines(lines.slice(0, contextSize)));\n\n          let hunk = {\n            oldStart: oldRangeStart,\n            oldLines: (oldLine - oldRangeStart + contextSize),\n            newStart: newRangeStart,\n            newLines: (newLine - newRangeStart + contextSize),\n            lines: curRange\n          };\n          if (i >= diff.length - 2 && lines.length <= options.context) {\n            // EOF is inside this hunk\n            let oldEOFNewline = ((/\\n$/).test(oldStr));\n            let newEOFNewline = ((/\\n$/).test(newStr));\n            let noNlBeforeAdds = lines.length == 0 && curRange.length > hunk.oldLines;\n            if (!oldEOFNewline && noNlBeforeAdds) {\n              // special case: old has no eol and no trailing context; no-nl can end up before adds\n              curRange.splice(hunk.oldLines, 0, '\\\\ No newline at end of file');\n            }\n            if ((!oldEOFNewline && !noNlBeforeAdds) || !newEOFNewline) {\n              curRange.push('\\\\ No newline at end of file');\n            }\n          }\n          hunks.push(hunk);\n\n          oldRangeStart = 0;\n          newRangeStart = 0;\n          curRange = [];\n        }\n      }\n      oldLine += lines.length;\n      newLine += lines.length;\n    }\n  }\n\n  return {\n    oldFileName: oldFileName, newFileName: newFileName,\n    oldHeader: oldHeader, newHeader: newHeader,\n    hunks: hunks\n  };\n}\n\nexport function createTwoFilesPatch(oldFileName, newFileName, oldStr, newStr, oldHeader, newHeader, options) {\n  const diff = structuredPatch(oldFileName, newFileName, oldStr, newStr, oldHeader, newHeader, options);\n\n  const ret = [];\n  if (oldFileName == newFileName) {\n    ret.push('Index: ' + oldFileName);\n  }\n  ret.push('===================================================================');\n  ret.push('--- ' + diff.oldFileName + (typeof diff.oldHeader === 'undefined' ? '' : '\\t' + diff.oldHeader));\n  ret.push('+++ ' + diff.newFileName + (typeof diff.newHeader === 'undefined' ? '' : '\\t' + diff.newHeader));\n\n  for (let i = 0; i < diff.hunks.length; i++) {\n    const hunk = diff.hunks[i];\n    ret.push(\n      '@@ -' + hunk.oldStart + ',' + hunk.oldLines\n      + ' +' + hunk.newStart + ',' + hunk.newLines\n      + ' @@'\n    );\n    ret.push.apply(ret, hunk.lines);\n  }\n\n  return ret.join('\\n') + '\\n';\n}\n\nexport function createPatch(fileName, oldStr, newStr, oldHeader, newHeader, options) {\n  return createTwoFilesPatch(fileName, fileName, oldStr, newStr, oldHeader, newHeader, options);\n}\n"],"mappings":"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"}
afe47eb2ddaf61af594b544dabe895ad
'use strict';

var Node = require('../nodes/Node.js');
var stringify = require('./stringify.js');
var stringifyComment = require('./stringifyComment.js');
function stringifyDocument(doc, options) {
  const lines = [];
  let hasDirectives = options.directives === true;
  if (options.directives !== false && doc.directives) {
    const dir = doc.directives.toString(doc);
    if (dir) {
      lines.push(dir);
      hasDirectives = true;
    } else if (doc.directives.docStart) hasDirectives = true;
  }
  if (hasDirectives) lines.push('---');
  const ctx = stringify.createStringifyContext(doc, options);
  const {
    commentString
  } = ctx.options;
  if (doc.commentBefore) {
    if (lines.length !== 1) lines.unshift('');
    const cs = commentString(doc.commentBefore);
    lines.unshift(stringifyComment.indentComment(cs, ''));
  }
  let chompKeep = false;
  let contentComment = null;
  if (doc.contents) {
    if (Node.isNode(doc.contents)) {
      if (doc.contents.spaceBefore && hasDirectives) lines.push('');
      if (doc.contents.commentBefore) {
        const cs = commentString(doc.contents.commentBefore);
        lines.push(stringifyComment.indentComment(cs, ''));
      }
      // top-level block scalars need to be indented if followed by a comment
      ctx.forceBlockIndent = !!doc.comment;
      contentComment = doc.contents.comment;
    }
    const onChompKeep = contentComment ? undefined : () => chompKeep = true;
    let body = stringify.stringify(doc.contents, ctx, () => contentComment = null, onChompKeep);
    if (contentComment) body += stringifyComment.lineComment(body, '', commentString(contentComment));
    if ((body[0] === '|' || body[0] === '>') && lines[lines.length - 1] === '---') {
      // Top-level block scalars with a preceding doc marker ought to use the
      // same line for their header.
      lines[lines.length - 1] = `--- ${body}`;
    } else lines.push(body);
  } else {
    lines.push(stringify.stringify(doc.contents, ctx));
  }
  if (doc.directives?.docEnd) {
    if (doc.comment) {
      const cs = commentString(doc.comment);
      if (cs.includes('\n')) {
        lines.push('...');
        lines.push(stringifyComment.indentComment(cs, ''));
      } else {
        lines.push(`... ${cs}`);
      }
    } else {
      lines.push('...');
    }
  } else {
    let dc = doc.comment;
    if (dc && chompKeep) dc = dc.replace(/^\n+/, '');
    if (dc) {
      if ((!chompKeep || contentComment) && lines[lines.length - 1] !== '') lines.push('');
      lines.push(stringifyComment.indentComment(commentString(dc), ''));
    }
  }
  return lines.join('\n') + '\n';
}
exports.stringifyDocument = stringifyDocument;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJOb2RlIiwicmVxdWlyZSIsInN0cmluZ2lmeSIsInN0cmluZ2lmeUNvbW1lbnQiLCJzdHJpbmdpZnlEb2N1bWVudCIsImRvYyIsIm9wdGlvbnMiLCJsaW5lcyIsImhhc0RpcmVjdGl2ZXMiLCJkaXJlY3RpdmVzIiwiZGlyIiwidG9TdHJpbmciLCJwdXNoIiwiZG9jU3RhcnQiLCJjdHgiLCJjcmVhdGVTdHJpbmdpZnlDb250ZXh0IiwiY29tbWVudFN0cmluZyIsImNvbW1lbnRCZWZvcmUiLCJsZW5ndGgiLCJ1bnNoaWZ0IiwiY3MiLCJpbmRlbnRDb21tZW50IiwiY2hvbXBLZWVwIiwiY29udGVudENvbW1lbnQiLCJjb250ZW50cyIsImlzTm9kZSIsInNwYWNlQmVmb3JlIiwiZm9yY2VCbG9ja0luZGVudCIsImNvbW1lbnQiLCJvbkNob21wS2VlcCIsInVuZGVmaW5lZCIsImJvZHkiLCJsaW5lQ29tbWVudCIsImRvY0VuZCIsImluY2x1ZGVzIiwiZGMiLCJyZXBsYWNlIiwiam9pbiIsImV4cG9ydHMiXSwic291cmNlcyI6WyJzdHJpbmdpZnlEb2N1bWVudC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbnZhciBOb2RlID0gcmVxdWlyZSgnLi4vbm9kZXMvTm9kZS5qcycpO1xudmFyIHN0cmluZ2lmeSA9IHJlcXVpcmUoJy4vc3RyaW5naWZ5LmpzJyk7XG52YXIgc3RyaW5naWZ5Q29tbWVudCA9IHJlcXVpcmUoJy4vc3RyaW5naWZ5Q29tbWVudC5qcycpO1xuXG5mdW5jdGlvbiBzdHJpbmdpZnlEb2N1bWVudChkb2MsIG9wdGlvbnMpIHtcbiAgICBjb25zdCBsaW5lcyA9IFtdO1xuICAgIGxldCBoYXNEaXJlY3RpdmVzID0gb3B0aW9ucy5kaXJlY3RpdmVzID09PSB0cnVlO1xuICAgIGlmIChvcHRpb25zLmRpcmVjdGl2ZXMgIT09IGZhbHNlICYmIGRvYy5kaXJlY3RpdmVzKSB7XG4gICAgICAgIGNvbnN0IGRpciA9IGRvYy5kaXJlY3RpdmVzLnRvU3RyaW5nKGRvYyk7XG4gICAgICAgIGlmIChkaXIpIHtcbiAgICAgICAgICAgIGxpbmVzLnB1c2goZGlyKTtcbiAgICAgICAgICAgIGhhc0RpcmVjdGl2ZXMgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGRvYy5kaXJlY3RpdmVzLmRvY1N0YXJ0KVxuICAgICAgICAgICAgaGFzRGlyZWN0aXZlcyA9IHRydWU7XG4gICAgfVxuICAgIGlmIChoYXNEaXJlY3RpdmVzKVxuICAgICAgICBsaW5lcy5wdXNoKCctLS0nKTtcbiAgICBjb25zdCBjdHggPSBzdHJpbmdpZnkuY3JlYXRlU3RyaW5naWZ5Q29udGV4dChkb2MsIG9wdGlvbnMpO1xuICAgIGNvbnN0IHsgY29tbWVudFN0cmluZyB9ID0gY3R4Lm9wdGlvbnM7XG4gICAgaWYgKGRvYy5jb21tZW50QmVmb3JlKSB7XG4gICAgICAgIGlmIChsaW5lcy5sZW5ndGggIT09IDEpXG4gICAgICAgICAgICBsaW5lcy51bnNoaWZ0KCcnKTtcbiAgICAgICAgY29uc3QgY3MgPSBjb21tZW50U3RyaW5nKGRvYy5jb21tZW50QmVmb3JlKTtcbiAgICAgICAgbGluZXMudW5zaGlmdChzdHJpbmdpZnlDb21tZW50LmluZGVudENvbW1lbnQoY3MsICcnKSk7XG4gICAgfVxuICAgIGxldCBjaG9tcEtlZXAgPSBmYWxzZTtcbiAgICBsZXQgY29udGVudENvbW1lbnQgPSBudWxsO1xuICAgIGlmIChkb2MuY29udGVudHMpIHtcbiAgICAgICAgaWYgKE5vZGUuaXNOb2RlKGRvYy5jb250ZW50cykpIHtcbiAgICAgICAgICAgIGlmIChkb2MuY29udGVudHMuc3BhY2VCZWZvcmUgJiYgaGFzRGlyZWN0aXZlcylcbiAgICAgICAgICAgICAgICBsaW5lcy5wdXNoKCcnKTtcbiAgICAgICAgICAgIGlmIChkb2MuY29udGVudHMuY29tbWVudEJlZm9yZSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNzID0gY29tbWVudFN0cmluZyhkb2MuY29udGVudHMuY29tbWVudEJlZm9yZSk7XG4gICAgICAgICAgICAgICAgbGluZXMucHVzaChzdHJpbmdpZnlDb21tZW50LmluZGVudENvbW1lbnQoY3MsICcnKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyB0b3AtbGV2ZWwgYmxvY2sgc2NhbGFycyBuZWVkIHRvIGJlIGluZGVudGVkIGlmIGZvbGxvd2VkIGJ5IGEgY29tbWVudFxuICAgICAgICAgICAgY3R4LmZvcmNlQmxvY2tJbmRlbnQgPSAhIWRvYy5jb21tZW50O1xuICAgICAgICAgICAgY29udGVudENvbW1lbnQgPSBkb2MuY29udGVudHMuY29tbWVudDtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBvbkNob21wS2VlcCA9IGNvbnRlbnRDb21tZW50ID8gdW5kZWZpbmVkIDogKCkgPT4gKGNob21wS2VlcCA9IHRydWUpO1xuICAgICAgICBsZXQgYm9keSA9IHN0cmluZ2lmeS5zdHJpbmdpZnkoZG9jLmNvbnRlbnRzLCBjdHgsICgpID0+IChjb250ZW50Q29tbWVudCA9IG51bGwpLCBvbkNob21wS2VlcCk7XG4gICAgICAgIGlmIChjb250ZW50Q29tbWVudClcbiAgICAgICAgICAgIGJvZHkgKz0gc3RyaW5naWZ5Q29tbWVudC5saW5lQ29tbWVudChib2R5LCAnJywgY29tbWVudFN0cmluZyhjb250ZW50Q29tbWVudCkpO1xuICAgICAgICBpZiAoKGJvZHlbMF0gPT09ICd8JyB8fCBib2R5WzBdID09PSAnPicpICYmXG4gICAgICAgICAgICBsaW5lc1tsaW5lcy5sZW5ndGggLSAxXSA9PT0gJy0tLScpIHtcbiAgICAgICAgICAgIC8vIFRvcC1sZXZlbCBibG9jayBzY2FsYXJzIHdpdGggYSBwcmVjZWRpbmcgZG9jIG1hcmtlciBvdWdodCB0byB1c2UgdGhlXG4gICAgICAgICAgICAvLyBzYW1lIGxpbmUgZm9yIHRoZWlyIGhlYWRlci5cbiAgICAgICAgICAgIGxpbmVzW2xpbmVzLmxlbmd0aCAtIDFdID0gYC0tLSAke2JvZHl9YDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlXG4gICAgICAgICAgICBsaW5lcy5wdXNoKGJvZHkpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgbGluZXMucHVzaChzdHJpbmdpZnkuc3RyaW5naWZ5KGRvYy5jb250ZW50cywgY3R4KSk7XG4gICAgfVxuICAgIGlmIChkb2MuZGlyZWN0aXZlcz8uZG9jRW5kKSB7XG4gICAgICAgIGlmIChkb2MuY29tbWVudCkge1xuICAgICAgICAgICAgY29uc3QgY3MgPSBjb21tZW50U3RyaW5nKGRvYy5jb21tZW50KTtcbiAgICAgICAgICAgIGlmIChjcy5pbmNsdWRlcygnXFxuJykpIHtcbiAgICAgICAgICAgICAgICBsaW5lcy5wdXNoKCcuLi4nKTtcbiAgICAgICAgICAgICAgICBsaW5lcy5wdXNoKHN0cmluZ2lmeUNvbW1lbnQuaW5kZW50Q29tbWVudChjcywgJycpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGxpbmVzLnB1c2goYC4uLiAke2NzfWApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgbGluZXMucHVzaCgnLi4uJyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGxldCBkYyA9IGRvYy5jb21tZW50O1xuICAgICAgICBpZiAoZGMgJiYgY2hvbXBLZWVwKVxuICAgICAgICAgICAgZGMgPSBkYy5yZXBsYWNlKC9eXFxuKy8sICcnKTtcbiAgICAgICAgaWYgKGRjKSB7XG4gICAgICAgICAgICBpZiAoKCFjaG9tcEtlZXAgfHwgY29udGVudENvbW1lbnQpICYmIGxpbmVzW2xpbmVzLmxlbmd0aCAtIDFdICE9PSAnJylcbiAgICAgICAgICAgICAgICBsaW5lcy5wdXNoKCcnKTtcbiAgICAgICAgICAgIGxpbmVzLnB1c2goc3RyaW5naWZ5Q29tbWVudC5pbmRlbnRDb21tZW50KGNvbW1lbnRTdHJpbmcoZGMpLCAnJykpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBsaW5lcy5qb2luKCdcXG4nKSArICdcXG4nO1xufVxuXG5leHBvcnRzLnN0cmluZ2lmeURvY3VtZW50ID0gc3RyaW5naWZ5RG9jdW1lbnQ7XG4iXSwibWFwcGluZ3MiOiJBQUFBLFlBQVk7O0FBRVosSUFBSUEsSUFBSSxHQUFHQyxPQUFPLENBQUMsa0JBQWtCLENBQUM7QUFDdEMsSUFBSUMsU0FBUyxHQUFHRCxPQUFPLENBQUMsZ0JBQWdCLENBQUM7QUFDekMsSUFBSUUsZ0JBQWdCLEdBQUdGLE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQztBQUV2RCxTQUFTRyxpQkFBaUJBLENBQUNDLEdBQUcsRUFBRUMsT0FBTyxFQUFFO0VBQ3JDLE1BQU1DLEtBQUssR0FBRyxFQUFFO0VBQ2hCLElBQUlDLGFBQWEsR0FBR0YsT0FBTyxDQUFDRyxVQUFVLEtBQUssSUFBSTtFQUMvQyxJQUFJSCxPQUFPLENBQUNHLFVBQVUsS0FBSyxLQUFLLElBQUlKLEdBQUcsQ0FBQ0ksVUFBVSxFQUFFO0lBQ2hELE1BQU1DLEdBQUcsR0FBR0wsR0FBRyxDQUFDSSxVQUFVLENBQUNFLFFBQVEsQ0FBQ04sR0FBRyxDQUFDO0lBQ3hDLElBQUlLLEdBQUcsRUFBRTtNQUNMSCxLQUFLLENBQUNLLElBQUksQ0FBQ0YsR0FBRyxDQUFDO01BQ2ZGLGFBQWEsR0FBRyxJQUFJO0lBQ3hCLENBQUMsTUFDSSxJQUFJSCxHQUFHLENBQUNJLFVBQVUsQ0FBQ0ksUUFBUSxFQUM1QkwsYUFBYSxHQUFHLElBQUk7RUFDNUI7RUFDQSxJQUFJQSxhQUFhLEVBQ2JELEtBQUssQ0FBQ0ssSUFBSSxDQUFDLEtBQUssQ0FBQztFQUNyQixNQUFNRSxHQUFHLEdBQUdaLFNBQVMsQ0FBQ2Esc0JBQXNCLENBQUNWLEdBQUcsRUFBRUMsT0FBTyxDQUFDO0VBQzFELE1BQU07SUFBRVU7RUFBYyxDQUFDLEdBQUdGLEdBQUcsQ0FBQ1IsT0FBTztFQUNyQyxJQUFJRCxHQUFHLENBQUNZLGFBQWEsRUFBRTtJQUNuQixJQUFJVixL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
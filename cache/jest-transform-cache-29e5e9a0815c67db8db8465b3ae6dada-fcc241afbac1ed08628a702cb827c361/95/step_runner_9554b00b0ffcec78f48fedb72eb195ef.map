{"version":3,"names":["stopwatch_1","require","user_code_runner_1","__importDefault","messages","__importStar","value_checker_1","format_error_1","run","defaultTimeout","filterStackTraces","hookParameter","step","stepDefinition","world","stopwatch","create","start","error","result","invocationData","getInvocationParameters","err","doesNotHaveValue","timeoutInMilliseconds","valueOrDefault","options","timeout","validCodeLengths","includes","code","length","data","default","argsArray","parameters","fn","thisArg","getInvalidCodeLengthMessage","duration","stop","status","details","TestStepResultStatus","SKIPPED","PENDING","doesHaveValue","formatError","FAILED","PASSED","exports"],"sources":["../../src/runtime/step_runner.ts"],"sourcesContent":["import { create } from './stopwatch'\nimport UserCodeRunner from '../user_code_runner'\nimport * as messages from '@cucumber/messages'\nimport { ITestCaseHookParameter } from '../support_code_library_builder/types'\nimport { IDefinition, IGetInvocationDataResponse } from '../models/definition'\nimport {\n  doesHaveValue,\n  doesNotHaveValue,\n  valueOrDefault,\n} from '../value_checker'\nimport { formatError } from './format_error'\n\nexport interface IRunOptions {\n  defaultTimeout: number\n  filterStackTraces: boolean\n  hookParameter: ITestCaseHookParameter\n  step: messages.PickleStep\n  stepDefinition: IDefinition\n  world: any\n}\n\nexport async function run({\n  defaultTimeout,\n  filterStackTraces,\n  hookParameter,\n  step,\n  stepDefinition,\n  world,\n}: IRunOptions): Promise<messages.TestStepResult> {\n  const stopwatch = create().start()\n  let error: any, result: any, invocationData: IGetInvocationDataResponse\n\n  try {\n    invocationData = await stepDefinition.getInvocationParameters({\n      hookParameter,\n      step,\n      world,\n    })\n  } catch (err) {\n    error = err\n  }\n\n  if (doesNotHaveValue(error)) {\n    const timeoutInMilliseconds = valueOrDefault(\n      stepDefinition.options.timeout,\n      defaultTimeout\n    )\n\n    if (invocationData.validCodeLengths.includes(stepDefinition.code.length)) {\n      const data = await UserCodeRunner.run({\n        argsArray: invocationData.parameters,\n        fn: stepDefinition.code,\n        thisArg: world,\n        timeoutInMilliseconds,\n      })\n      error = data.error\n      result = data.result\n    } else {\n      error = invocationData.getInvalidCodeLengthMessage()\n    }\n  }\n\n  const duration = stopwatch.stop().duration()\n  let status: messages.TestStepResultStatus\n  let details = {}\n  if (result === 'skipped') {\n    status = messages.TestStepResultStatus.SKIPPED\n  } else if (result === 'pending') {\n    status = messages.TestStepResultStatus.PENDING\n  } else if (doesHaveValue(error)) {\n    details = formatError(error, filterStackTraces)\n    status = messages.TestStepResultStatus.FAILED\n  } else {\n    status = messages.TestStepResultStatus.PASSED\n  }\n\n  return {\n    duration,\n    status,\n    ...details,\n  }\n}\n\nexport default { run }\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,MAAAA,WAAA,GAAAC,OAAA;AACA,MAAAC,kBAAA,GAAAC,eAAA,CAAAF,OAAA;AACA,MAAAG,QAAA,GAAAC,YAAA,CAAAJ,OAAA;AAGA,MAAAK,eAAA,GAAAL,OAAA;AAKA,MAAAM,cAAA,GAAAN,OAAA;AAWO,eAAeO,GAAGA,CAAC;EACxBC,cAAc;EACdC,iBAAiB;EACjBC,aAAa;EACbC,IAAI;EACJC,cAAc;EACdC;AAAK,CACO;EACZ,MAAMC,SAAS,GAAG,IAAAf,WAAA,CAAAgB,MAAM,GAAE,CAACC,KAAK,EAAE;EAClC,IAAIC,KAAU,EAAEC,MAAW,EAAEC,cAA0C;EAEvE,IAAI;IACFA,cAAc,GAAG,MAAMP,cAAc,CAACQ,uBAAuB,CAAC;MAC5DV,aAAa;MACbC,IAAI;MACJE;KACD,CAAC;GACH,CAAC,OAAOQ,GAAG,EAAE;IACZJ,KAAK,GAAGI,GAAG;;EAGb,IAAI,IAAAhB,eAAA,CAAAiB,gBAAgB,EAACL,KAAK,CAAC,EAAE;IAC3B,MAAMM,qBAAqB,GAAG,IAAAlB,eAAA,CAAAmB,cAAc,EAC1CZ,cAAc,CAACa,OAAO,CAACC,OAAO,EAC9BlB,cAAc,CACf;IAED,IAAIW,cAAc,CAACQ,gBAAgB,CAACC,QAAQ,CAAChB,cAAc,CAACiB,IAAI,CAACC,MAAM,CAAC,EAAE;MACxE,MAAMC,IAAI,GAAG,MAAM9B,kBAAA,CAAA+B,OAAc,CAACzB,GAAG,CAAC;QACpC0B,SAAS,EAAEd,cAAc,CAACe,UAAU;QACpCC,EAAE,EAAEvB,cAAc,CAACiB,IAAI;QACvBO,OAAO,EAAEvB,KAAK;QACdU;OACD,CAAC;MACFN,KAAK,GAAGc,IAAI,CAACd,KAAK;MAClBC,MAAM,GAAGa,IAAI,CAACb,MAAM;KACrB,MAAM;MACLD,KAAK,GAAGE,cAAc,CAACkB,2BAA2B,EAAE;;;EAIxD,MAAMC,QAAQ,GAAGxB,SAAS,CAACyB,IAAI,EAAE,CAACD,QAAQ,EAAE;EAC5C,IAAIE,MAAqC;EACzC,IAAIC,OAAO,GAAG,EAAE;EAChB,IAAIvB,MAAM,KAAK,SAAS,EAAE;IACxBsB,MAAM,GAAGrC,QAAQ,CAACuC,oBAAoB,CAACC,OAAO;GAC/C,MAAM,IAAIzB,MAAM,KAAK,SAAS,EAAE;IAC/BsB,MAAM,GAAGrC,QAAQ,CAACuC,oBAAoB,CAACE,OAAO;GAC/C,MAAM,IAAI,IAAAvC,eAAA,CAAAwC,aAAa,EAAC5B,KAAK,CAAC,EAAE;IAC/BwB,OAAO,GAAG,IAAAnC,cAAA,CAAAwC,WAAW,EAAC7B,KAAK,EAAER,iBAAiB,CAAC;IAC/C+B,MAAM,GAAGrC,QAAQ,CAACuC,oBAAoB,CAACK,MAAM;GAC9C,MAAM;IACLP,MAAM,GAAGrC,QAAQ,CAACuC,oBAAoB,CAACM,MAAM;;EAG/C,OAAO;IACLV,QAAQ;IACRE,MAAM;IACN,GAAGC;GACJ;AACH;AA5DAQ,OAAA,CAAA1C,GAAA,GAAAA,GAAA;AA8DA0C,OAAA,CAAAjB,OAAA,GAAe;EAAEzB;AAAG,CAAE"}
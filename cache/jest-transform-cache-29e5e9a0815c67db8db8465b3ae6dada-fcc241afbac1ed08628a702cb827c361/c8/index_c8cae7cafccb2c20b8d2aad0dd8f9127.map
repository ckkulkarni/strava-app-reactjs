{"version":3,"names":["_jsdom","data","require","_fakeTimers","_jestMock","_jestUtil","_defineProperty","obj","key","value","Object","defineProperty","enumerable","configurable","writable","JSDOMEnvironment","constructor","config","options","dom","JSDOM","testEnvironmentOptions","html","pretendToBeVisual","resources","userAgent","ResourceLoader","undefined","runScripts","url","testURL","virtualConsole","VirtualConsole","sendTo","console","global","window","document","defaultView","Error","stackTraceLimit","installCommonGlobals","globals","Buffer","errorEventListener","event","userErrorListenerCount","error","process","emit","addEventListener","originalAddListener","originalRemoveListener","removeEventListener","args","apply","moduleMocker","ModuleMocker","timerConfig","idToRef","id","refToId","ref","fakeTimers","LegacyFakeTimers","fakeTimersModern","ModernFakeTimers","setup","teardown","dispose","close","getVmContext","getInternalVMContext","module","exports"],"sources":["index.js"],"sourcesContent":["'use strict';\n\nfunction _jsdom() {\n  const data = require('jsdom');\n\n  _jsdom = function () {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _fakeTimers() {\n  const data = require('@jest/fake-timers');\n\n  _fakeTimers = function () {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _jestMock() {\n  const data = require('jest-mock');\n\n  _jestMock = function () {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _jestUtil() {\n  const data = require('jest-util');\n\n  _jestUtil = function () {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n  return obj;\n}\n\nclass JSDOMEnvironment {\n  constructor(config, options) {\n    _defineProperty(this, 'dom', void 0);\n\n    _defineProperty(this, 'fakeTimers', void 0);\n\n    _defineProperty(this, 'fakeTimersModern', void 0);\n\n    _defineProperty(this, 'global', void 0);\n\n    _defineProperty(this, 'errorEventListener', void 0);\n\n    _defineProperty(this, 'moduleMocker', void 0);\n\n    this.dom = new (_jsdom().JSDOM)(\n      typeof config.testEnvironmentOptions.html === 'string'\n        ? config.testEnvironmentOptions.html\n        : '<!DOCTYPE html>',\n      {\n        pretendToBeVisual: true,\n        resources:\n          typeof config.testEnvironmentOptions.userAgent === 'string'\n            ? new (_jsdom().ResourceLoader)({\n                userAgent: config.testEnvironmentOptions.userAgent\n              })\n            : undefined,\n        runScripts: 'dangerously',\n        url: config.testURL,\n        virtualConsole: new (_jsdom().VirtualConsole)().sendTo(\n          (options === null || options === void 0 ? void 0 : options.console) ||\n            console\n        ),\n        ...config.testEnvironmentOptions\n      }\n    );\n    const global = (this.global = this.dom.window.document.defaultView);\n\n    if (!global) {\n      throw new Error('JSDOM did not return a Window object');\n    } // for \"universal\" code (code should use `globalThis`)\n\n    global.global = global; // Node's error-message stack size is limited at 10, but it's pretty useful\n    // to see more than that when a test fails.\n\n    this.global.Error.stackTraceLimit = 100;\n    (0, _jestUtil().installCommonGlobals)(global, config.globals); // TODO: remove this ASAP, but it currently causes tests to run really slow\n\n    global.Buffer = Buffer; // Report uncaught errors.\n\n    this.errorEventListener = event => {\n      if (userErrorListenerCount === 0 && event.error) {\n        process.emit('uncaughtException', event.error);\n      }\n    };\n\n    global.addEventListener('error', this.errorEventListener); // However, don't report them as uncaught if the user listens to 'error' event.\n    // In that case, we assume the might have custom error handling logic.\n\n    const originalAddListener = global.addEventListener;\n    const originalRemoveListener = global.removeEventListener;\n    let userErrorListenerCount = 0;\n\n    global.addEventListener = function (...args) {\n      if (args[0] === 'error') {\n        userErrorListenerCount++;\n      }\n\n      return originalAddListener.apply(this, args);\n    };\n\n    global.removeEventListener = function (...args) {\n      if (args[0] === 'error') {\n        userErrorListenerCount--;\n      }\n\n      return originalRemoveListener.apply(this, args);\n    };\n\n    this.moduleMocker = new (_jestMock().ModuleMocker)(global);\n    const timerConfig = {\n      idToRef: id => id,\n      refToId: ref => ref\n    };\n    this.fakeTimers = new (_fakeTimers().LegacyFakeTimers)({\n      config,\n      global: global,\n      moduleMocker: this.moduleMocker,\n      timerConfig\n    });\n    this.fakeTimersModern = new (_fakeTimers().ModernFakeTimers)({\n      config,\n      global: global\n    });\n  }\n\n  async setup() {}\n\n  async teardown() {\n    if (this.fakeTimers) {\n      this.fakeTimers.dispose();\n    }\n\n    if (this.fakeTimersModern) {\n      this.fakeTimersModern.dispose();\n    }\n\n    if (this.global) {\n      if (this.errorEventListener) {\n        this.global.removeEventListener('error', this.errorEventListener);\n      }\n\n      this.global.close(); // Dispose \"document\" to prevent \"load\" event from triggering.\n      // Note that this.global.close() will trigger the CustomElement::disconnectedCallback\n      // Do not reset the document before CustomElement disconnectedCallback function has finished running,\n      // document should be accessible within disconnectedCallback.\n\n      Object.defineProperty(this.global, 'document', {\n        value: null\n      });\n    }\n\n    this.errorEventListener = null; // @ts-expect-error\n\n    this.global = null;\n    this.dom = null;\n    this.fakeTimers = null;\n    this.fakeTimersModern = null;\n  }\n\n  getVmContext() {\n    if (this.dom) {\n      return this.dom.getInternalVMContext();\n    }\n\n    return null;\n  }\n}\n\nmodule.exports = JSDOMEnvironment;\n"],"mappings":"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"}
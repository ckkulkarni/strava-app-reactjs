{"version":3,"names":["exports","__esModule","createSubscription","_batch","require","createListenerCollection","batch","getBatch","first","last","clear","notify","listener","callback","next","get","listeners","push","subscribe","isSubscribed","prev","unsubscribe","nullListeners","store","parentSub","addNestedSub","trySubscribe","notifyNestedSubs","handleChangeWrapper","subscription","onStateChange","Boolean","tryUnsubscribe","undefined","getListeners"],"sources":["Subscription.js"],"sourcesContent":["\"use strict\";\n\nexports.__esModule = true;\nexports.createSubscription = createSubscription;\n\nvar _batch = require(\"./batch\");\n\nfunction createListenerCollection() {\n  const batch = (0, _batch.getBatch)();\n  let first = null;\n  let last = null;\n  return {\n    clear() {\n      first = null;\n      last = null;\n    },\n\n    notify() {\n      batch(() => {\n        let listener = first;\n\n        while (listener) {\n          listener.callback();\n          listener = listener.next;\n        }\n      });\n    },\n\n    get() {\n      let listeners = [];\n      let listener = first;\n\n      while (listener) {\n        listeners.push(listener);\n        listener = listener.next;\n      }\n\n      return listeners;\n    },\n\n    subscribe(callback) {\n      let isSubscribed = true;\n      let listener = last = {\n        callback,\n        next: null,\n        prev: last\n      };\n\n      if (listener.prev) {\n        listener.prev.next = listener;\n      } else {\n        first = listener;\n      }\n\n      return function unsubscribe() {\n        if (!isSubscribed || first === null) return;\n        isSubscribed = false;\n\n        if (listener.next) {\n          listener.next.prev = listener.prev;\n        } else {\n          last = listener.prev;\n        }\n\n        if (listener.prev) {\n          listener.prev.next = listener.next;\n        } else {\n          first = listener.next;\n        }\n      };\n    }\n\n  };\n}\n\nconst nullListeners = {\n  notify() {},\n\n  get: () => []\n};\n\nfunction createSubscription(store, parentSub) {\n  let unsubscribe;\n  let listeners = nullListeners;\n\n  function addNestedSub(listener) {\n    trySubscribe();\n    return listeners.subscribe(listener);\n  }\n\n  function notifyNestedSubs() {\n    listeners.notify();\n  }\n\n  function handleChangeWrapper() {\n    if (subscription.onStateChange) {\n      subscription.onStateChange();\n    }\n  }\n\n  function isSubscribed() {\n    return Boolean(unsubscribe);\n  }\n\n  function trySubscribe() {\n    if (!unsubscribe) {\n      unsubscribe = parentSub ? parentSub.addNestedSub(handleChangeWrapper) : store.subscribe(handleChangeWrapper);\n      listeners = createListenerCollection();\n    }\n  }\n\n  function tryUnsubscribe() {\n    if (unsubscribe) {\n      unsubscribe();\n      unsubscribe = undefined;\n      listeners.clear();\n      listeners = nullListeners;\n    }\n  }\n\n  const subscription = {\n    addNestedSub,\n    notifyNestedSubs,\n    handleChangeWrapper,\n    isSubscribed,\n    trySubscribe,\n    tryUnsubscribe,\n    getListeners: () => listeners\n  };\n  return subscription;\n}"],"mappings":"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"}
{"version":3,"names":["BREAK","Symbol","SKIP","REMOVE","visit","cst","visitor","type","start","value","_visit","Object","freeze","itemAtPath","path","item","field","index","tok","items","undefined","parentCollection","parent","slice","length","coll","Error","ctrl","token","i","ci","concat","splice","exports"],"sources":["cst-visit.js"],"sourcesContent":["'use strict';\n\nconst BREAK = Symbol('break visit');\nconst SKIP = Symbol('skip children');\nconst REMOVE = Symbol('remove item');\n/**\n * Apply a visitor to a CST document or item.\n *\n * Walks through the tree (depth-first) starting from the root, calling a\n * `visitor` function with two arguments when entering each item:\n *   - `item`: The current item, which included the following members:\n *     - `start: SourceToken[]` – Source tokens before the key or value,\n *       possibly including its anchor or tag.\n *     - `key?: Token | null` – Set for pair values. May then be `null`, if\n *       the key before the `:` separator is empty.\n *     - `sep?: SourceToken[]` – Source tokens between the key and the value,\n *       which should include the `:` map value indicator if `value` is set.\n *     - `value?: Token` – The value of a sequence item, or of a map pair.\n *   - `path`: The steps from the root to the current node, as an array of\n *     `['key' | 'value', number]` tuples.\n *\n * The return value of the visitor may be used to control the traversal:\n *   - `undefined` (default): Do nothing and continue\n *   - `visit.SKIP`: Do not visit the children of this token, continue with\n *      next sibling\n *   - `visit.BREAK`: Terminate traversal completely\n *   - `visit.REMOVE`: Remove the current item, then continue with the next one\n *   - `number`: Set the index of the next step. This is useful especially if\n *     the index of the current token has changed.\n *   - `function`: Define the next visitor for this item. After the original\n *     visitor is called on item entry, next visitors are called after handling\n *     a non-empty `key` and when exiting the item.\n */\nfunction visit(cst, visitor) {\n    if ('type' in cst && cst.type === 'document')\n        cst = { start: cst.start, value: cst.value };\n    _visit(Object.freeze([]), cst, visitor);\n}\n// Without the `as symbol` casts, TS declares these in the `visit`\n// namespace using `var`, but then complains about that because\n// `unique symbol` must be `const`.\n/** Terminate visit traversal completely */\nvisit.BREAK = BREAK;\n/** Do not visit the children of the current item */\nvisit.SKIP = SKIP;\n/** Remove the current item */\nvisit.REMOVE = REMOVE;\n/** Find the item at `path` from `cst` as the root */\nvisit.itemAtPath = (cst, path) => {\n    let item = cst;\n    for (const [field, index] of path) {\n        const tok = item?.[field];\n        if (tok && 'items' in tok) {\n            item = tok.items[index];\n        }\n        else\n            return undefined;\n    }\n    return item;\n};\n/**\n * Get the immediate parent collection of the item at `path` from `cst` as the root.\n *\n * Throws an error if the collection is not found, which should never happen if the item itself exists.\n */\nvisit.parentCollection = (cst, path) => {\n    const parent = visit.itemAtPath(cst, path.slice(0, -1));\n    const field = path[path.length - 1][0];\n    const coll = parent?.[field];\n    if (coll && 'items' in coll)\n        return coll;\n    throw new Error('Parent collection not found');\n};\nfunction _visit(path, item, visitor) {\n    let ctrl = visitor(item, path);\n    if (typeof ctrl === 'symbol')\n        return ctrl;\n    for (const field of ['key', 'value']) {\n        const token = item[field];\n        if (token && 'items' in token) {\n            for (let i = 0; i < token.items.length; ++i) {\n                const ci = _visit(Object.freeze(path.concat([[field, i]])), token.items[i], visitor);\n                if (typeof ci === 'number')\n                    i = ci - 1;\n                else if (ci === BREAK)\n                    return BREAK;\n                else if (ci === REMOVE) {\n                    token.items.splice(i, 1);\n                    i -= 1;\n                }\n            }\n            if (typeof ctrl === 'function' && field === 'key')\n                ctrl = ctrl(item, path);\n        }\n    }\n    return typeof ctrl === 'function' ? ctrl(item, path) : ctrl;\n}\n\nexports.visit = visit;\n"],"mappings":"AAAA,YAAY;;AAEZ,MAAMA,KAAK,GAAGC,MAAM,CAAC,aAAa,CAAC;AACnC,MAAMC,IAAI,GAAGD,MAAM,CAAC,eAAe,CAAC;AACpC,MAAME,MAAM,GAAGF,MAAM,CAAC,aAAa,CAAC;AACpC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAASG,KAAKA,CAACC,GAAG,EAAEC,OAAO,EAAE;EACzB,IAAI,MAAM,IAAID,GAAG,IAAIA,GAAG,CAACE,IAAI,KAAK,UAAU,EACxCF,GAAG,GAAG;IAAEG,KAAK,EAAEH,GAAG,CAACG,KAAK;IAAEC,KAAK,EAAEJ,GAAG,CAACI;EAAM,CAAC;EAChDC,MAAM,CAACC,MAAM,CAACC,MAAM,CAAC,EAAE,CAAC,EAAEP,GAAG,EAAEC,OAAO,CAAC;AAC3C;AACA;AACA;AACA;AACA;AACAF,KAAK,CAACJ,KAAK,GAAGA,KAAK;AACnB;AACAI,KAAK,CAACF,IAAI,GAAGA,IAAI;AACjB;AACAE,KAAK,CAACD,MAAM,GAAGA,MAAM;AACrB;AACAC,KAAK,CAACS,UAAU,GAAG,CAACR,GAAG,EAAES,IAAI,KAAK;EAC9B,IAAIC,IAAI,GAAGV,GAAG;EACd,KAAK,MAAM,CAACW,KAAK,EAAEC,KAAK,CAAC,IAAIH,IAAI,EAAE;IAC/B,MAAMI,GAAG,GAAGH,IAAI,GAAGC,KAAK,CAAC;IACzB,IAAIE,GAAG,IAAI,OAAO,IAAIA,GAAG,EAAE;MACvBH,IAAI,GAAGG,GAAG,CAACC,KAAK,CAACF,KAAK,CAAC;IAC3B,CAAC,MAEG,OAAOG,SAAS;EACxB;EACA,OAAOL,IAAI;AACf,CAAC;AACD;AACA;AACA;AACA;AACA;AACAX,KAAK,CAACiB,gBAAgB,GAAG,CAAChB,GAAG,EAAES,IAAI,KAAK;EACpC,MAAMQ,MAAM,GAAGlB,KAAK,CAACS,UAAU,CAACR,GAAG,EAAES,IAAI,CAACS,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;EACvD,MAAMP,KAAK,GAAGF,IAAI,CAACA,IAAI,CAACU,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;EACtC,MAAMC,IAAI,GAAGH,MAAM,GAAGN,KAAK,CAAC;EAC5B,IAAIS,IAAI,IAAI,OAAO,IAAIA,IAAI,EACvB,OAAOA,IAAI;EACf,MAAM,IAAIC,KAAK,CAAC,6BAA6B,CAAC;AAClD,CAAC;AACD,SAAShB,MAAMA,CAACI,IAAI,EAAEC,IAAI,EAAET,OAAO,EAAE;EACjC,IAAIqB,IAAI,GAAGrB,OAAO,CAACS,IAAI,EAAED,IAAI,CAAC;EAC9B,IAAI,OAAOa,IAAI,KAAK,QAAQ,EACxB,OAAOA,IAAI;EACf,KAAK,MAAMX,KAAK,IAAI,CAAC,KAAK,EAAE,OAAO,CAAC,EAAE;IAClC,MAAMY,KAAK,GAAGb,IAAI,CAACC,KAAK,CAAC;IACzB,IAAIY,KAAK,IAAI,OAAO,IAAIA,KAAK,EAAE;MAC3B,KAAK,IAAIC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGD,KAAK,CAACT,KAAK,CAACK,MAAM,EAAE,EAAEK,CAAC,EAAE;QACzC,MAAMC,EAAE,GAAGpB,MAAM,CAACC,MAAM,CAACC,MAAM,CAACE,IAAI,CAACiB,MAAM,CAAC,CAAC,CAACf,KAAK,EAAEa,CAAC,CAAC,CAAC,CAAC,CAAC,EAAED,KAAK,CAACT,KAAK,CAACU,CAAC,CAAC,EAAEvB,OAAO,CAAC;QACpF,IAAI,OAAOwB,EAAE,KAAK,QAAQ,EACtBD,CAAC,GAAGC,EAAE,GAAG,CAAC,CAAC,KACV,IAAIA,EAAE,KAAK9B,KAAK,EACjB,OAAOA,KAAK,CAAC,KACZ,IAAI8B,EAAE,KAAK3B,MAAM,EAAE;UACpByB,KAAK,CAACT,KAAK,CAACa,MAAM,CAACH,CAAC,EAAE,CAAC,CAAC;UACxBA,CAAC,IAAI,CAAC;QACV;MACJ;MACA,IAAI,OAAOF,IAAI,KAAK,UAAU,IAAIX,KAAK,KAAK,KAAK,EAC7CW,IAAI,GAAGA,IAAI,CAACZ,IAAI,EAAED,IAAI,CAAC;IAC/B;EACJ;EACA,OAAO,OAAOa,IAAI,KAAK,UAAU,GAAGA,IAAI,CAACZ,IAAI,EAAED,IAAI,CAAC,GAAGa,IAAI;AAC/D;AAEAM,OAAO,CAAC7B,KAAK,GAAGA,KAAK"}
{"version":3,"names":["_1","__importDefault","require","gherkin_document_parser_1","value_checker_1","messages","__importStar","DEFAULT_SEPARATOR","RerunFormatter","default","constructor","options","eventBroadcaster","on","envelope","doesHaveValue","testRunFinished","logFailedTestCases","rerunOptions","valueOrDefault","parsedArgvOptions","rerun","separator","mapping","eventDataCollector","getTestCaseAttempts","forEach","gherkinDocument","pickle","worstTestStepResult","status","TestStepResultStatus","PASSED","relativeUri","uri","line","getGherkinScenarioLocationMap","astNodeIds","length","doesNotHaveValue","push","text","Object","keys","map","lines","join","log","exports","documentation"],"sources":["../../src/formatter/rerun_formatter.ts"],"sourcesContent":["import Formatter, { IFormatterOptions } from './'\nimport { getGherkinScenarioLocationMap } from './helpers/gherkin_document_parser'\nimport {\n  doesHaveValue,\n  doesNotHaveValue,\n  valueOrDefault,\n} from '../value_checker'\nimport * as messages from '@cucumber/messages'\n\nconst DEFAULT_SEPARATOR = '\\n'\n\ninterface UriToLinesMap {\n  [uri: string]: number[]\n}\n\nexport default class RerunFormatter extends Formatter {\n  private readonly separator: string\n  public static readonly documentation: string =\n    'Prints failing files with line numbers.'\n\n  constructor(options: IFormatterOptions) {\n    super(options)\n    options.eventBroadcaster.on('envelope', (envelope: messages.Envelope) => {\n      if (doesHaveValue(envelope.testRunFinished)) {\n        this.logFailedTestCases()\n      }\n    })\n    const rerunOptions = valueOrDefault(options.parsedArgvOptions.rerun, {})\n    this.separator = valueOrDefault(rerunOptions.separator, DEFAULT_SEPARATOR)\n  }\n\n  logFailedTestCases(): void {\n    const mapping: UriToLinesMap = {}\n    this.eventDataCollector\n      .getTestCaseAttempts()\n      .forEach(({ gherkinDocument, pickle, worstTestStepResult }) => {\n        if (\n          worstTestStepResult.status !== messages.TestStepResultStatus.PASSED\n        ) {\n          const relativeUri = pickle.uri\n          const line =\n            getGherkinScenarioLocationMap(gherkinDocument)[\n              pickle.astNodeIds[pickle.astNodeIds.length - 1]\n            ].line\n          if (doesNotHaveValue(mapping[relativeUri])) {\n            mapping[relativeUri] = []\n          }\n          mapping[relativeUri].push(line)\n        }\n      })\n    const text = Object.keys(mapping)\n      .map((uri) => {\n        const lines = mapping[uri]\n        return `${uri}:${lines.join(':')}`\n      })\n      .join(this.separator)\n    this.log(text)\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,MAAAA,EAAA,GAAAC,eAAA,CAAAC,OAAA;AACA,MAAAC,yBAAA,GAAAD,OAAA;AACA,MAAAE,eAAA,GAAAF,OAAA;AAKA,MAAAG,QAAA,GAAAC,YAAA,CAAAJ,OAAA;AAEA,MAAMK,iBAAiB,GAAG,IAAI;AAM9B,MAAqBC,cAAe,SAAQR,EAAA,CAAAS,OAAS;EAKnDC,YAAYC,OAA0B;IACpC,KAAK,CAACA,OAAO,CAAC;IACdA,OAAO,CAACC,gBAAgB,CAACC,EAAE,CAAC,UAAU,EAAGC,QAA2B,IAAI;MACtE,IAAI,IAAAV,eAAA,CAAAW,aAAa,EAACD,QAAQ,CAACE,eAAe,CAAC,EAAE;QAC3C,IAAI,CAACC,kBAAkB,EAAE;;IAE7B,CAAC,CAAC;IACF,MAAMC,YAAY,GAAG,IAAAd,eAAA,CAAAe,cAAc,EAACR,OAAO,CAACS,iBAAiB,CAACC,KAAK,EAAE,EAAE,CAAC;IACxE,IAAI,CAACC,SAAS,GAAG,IAAAlB,eAAA,CAAAe,cAAc,EAACD,YAAY,CAACI,SAAS,EAAEf,iBAAiB,CAAC;EAC5E;EAEAU,kBAAkBA,CAAA;IAChB,MAAMM,OAAO,GAAkB,EAAE;IACjC,IAAI,CAACC,kBAAkB,CACpBC,mBAAmB,EAAE,CACrBC,OAAO,CAAC,CAAC;MAAEC,eAAe;MAAEC,MAAM;MAAEC;IAAmB,CAAE,KAAI;MAC5D,IACEA,mBAAmB,CAACC,MAAM,KAAKzB,QAAQ,CAAC0B,oBAAoB,CAACC,MAAM,EACnE;QACA,MAAMC,WAAW,GAAGL,MAAM,CAACM,GAAG;QAC9B,MAAMC,IAAI,GACR,IAAAhC,yBAAA,CAAAiC,6BAA6B,EAACT,eAAe,CAAC,CAC5CC,MAAM,CAACS,UAAU,CAACT,MAAM,CAACS,UAAU,CAACC,MAAM,GAAG,CAAC,CAAC,CAChD,CAACH,IAAI;QACR,IAAI,IAAA/B,eAAA,CAAAmC,gBAAgB,EAAChB,OAAO,CAACU,WAAW,CAAC,CAAC,EAAE;UAC1CV,OAAO,CAACU,WAAW,CAAC,GAAG,EAAE;;QAE3BV,OAAO,CAACU,WAAW,CAAC,CAACO,IAAI,CAACL,IAAI,CAAC;;IAEnC,CAAC,CAAC;IACJ,MAAMM,IAAI,GAAGC,MAAM,CAACC,IAAI,CAACpB,OAAO,CAAC,CAC9BqB,GAAG,CAAEV,GAAG,IAAI;MACX,MAAMW,KAAK,GAAGtB,OAAO,CAACW,GAAG,CAAC;MAC1B,OAAO,GAAGA,GAAG,IAAIW,KAAK,CAACC,IAAI,CAAC,GAAG,CAAC,EAAE;IACpC,CAAC,CAAC,CACDA,IAAI,CAAC,IAAI,CAACxB,SAAS,CAAC;IACvB,IAAI,CAACyB,GAAG,CAACN,IAAI,CAAC;EAChB;;AA1CFO,OAAA,CAAAvC,OAAA,GAAAD,cAAA;AAEyBA,cAAA,CAAAyC,aAAa,GAClC,yCAAyC"}
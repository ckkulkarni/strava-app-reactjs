{"version":3,"names":["PluginManager","constructor","pluginFns","handlers","message","cleanupFns","register","event","handler","push","init","logger","configuration","environment","pluginFn","cleanupFn","on","bind","emit","value","forEach","cleanup","exports"],"sources":["../../src/plugin/plugin_manager.ts"],"sourcesContent":["import { Plugin, PluginCleanup, PluginEvents } from './types'\nimport { IRunEnvironment, IRunOptions } from '../api'\nimport { ILogger } from '../logger'\n\ntype HandlerRegistry = {\n  [K in keyof PluginEvents]: Array<(value: PluginEvents[K]) => void>\n}\n\nexport class PluginManager {\n  private handlers: HandlerRegistry = { message: [] }\n  private cleanupFns: PluginCleanup[] = []\n\n  constructor(private pluginFns: Plugin[]) {}\n\n  private async register<K extends keyof PluginEvents>(\n    event: K,\n    handler: (value: PluginEvents[K]) => void\n  ) {\n    this.handlers[event].push(handler)\n  }\n\n  async init(\n    logger: ILogger,\n    configuration: IRunOptions,\n    environment: IRunEnvironment\n  ) {\n    for (const pluginFn of this.pluginFns) {\n      const cleanupFn = await pluginFn({\n        on: this.register.bind(this),\n        logger,\n        configuration,\n        environment,\n      })\n      if (cleanupFn) {\n        this.cleanupFns.push(cleanupFn)\n      }\n    }\n  }\n\n  emit<K extends keyof PluginEvents>(event: K, value: PluginEvents[K]): void {\n    this.handlers[event].forEach((handler) => handler(value))\n  }\n\n  async cleanup(): Promise<void> {\n    for (const cleanupFn of this.cleanupFns) {\n      await cleanupFn()\n    }\n  }\n}\n"],"mappings":";;;;;;AAQA,MAAaA,aAAa;EAIxBC,YAAoBC,SAAmB;IAAnB,KAAAA,SAAS,GAATA,SAAS;IAHrB,KAAAC,QAAQ,GAAoB;MAAEC,OAAO,EAAE;IAAE,CAAE;IAC3C,KAAAC,UAAU,GAAoB,EAAE;EAEE;EAElC,MAAMC,QAAQA,CACpBC,KAAQ,EACRC,OAAyC;IAEzC,IAAI,CAACL,QAAQ,CAACI,KAAK,CAAC,CAACE,IAAI,CAACD,OAAO,CAAC;EACpC;EAEA,MAAME,IAAIA,CACRC,MAAe,EACfC,aAA0B,EAC1BC,WAA4B;IAE5B,KAAK,MAAMC,QAAQ,IAAI,IAAI,CAACZ,SAAS,EAAE;MACrC,MAAMa,SAAS,GAAG,MAAMD,QAAQ,CAAC;QAC/BE,EAAE,EAAE,IAAI,CAACV,QAAQ,CAACW,IAAI,CAAC,IAAI,CAAC;QAC5BN,MAAM;QACNC,aAAa;QACbC;OACD,CAAC;MACF,IAAIE,SAAS,EAAE;QACb,IAAI,CAACV,UAAU,CAACI,IAAI,CAACM,SAAS,CAAC;;;EAGrC;EAEAG,IAAIA,CAA+BX,KAAQ,EAAEY,KAAsB;IACjE,IAAI,CAAChB,QAAQ,CAACI,KAAK,CAAC,CAACa,OAAO,CAAEZ,OAAO,IAAKA,OAAO,CAACW,KAAK,CAAC,CAAC;EAC3D;EAEA,MAAME,OAAOA,CAAA;IACX,KAAK,MAAMN,SAAS,IAAI,IAAI,CAACV,UAAU,EAAE;MACvC,MAAMU,SAAS,EAAE;;EAErB;;AAvCFO,OAAA,CAAAtB,aAAA,GAAAA,aAAA"}
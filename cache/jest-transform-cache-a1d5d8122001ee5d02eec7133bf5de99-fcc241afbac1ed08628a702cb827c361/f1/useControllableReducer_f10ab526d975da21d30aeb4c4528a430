1ac300cee7055f9ee9b8d05a248880fd
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = useControllableReducer;
var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));
var React = _interopRequireWildcard(require("react"));
var _useListbox = require("./useListbox.types");
var _areArraysEqual = _interopRequireDefault(require("../utils/areArraysEqual"));
function _getRequireWildcardCache(nodeInterop) {
  if (typeof WeakMap !== "function") return null;
  var cacheBabelInterop = new WeakMap();
  var cacheNodeInterop = new WeakMap();
  return (_getRequireWildcardCache = function (nodeInterop) {
    return nodeInterop ? cacheNodeInterop : cacheBabelInterop;
  })(nodeInterop);
}
function _interopRequireWildcard(obj, nodeInterop) {
  if (!nodeInterop && obj && obj.__esModule) {
    return obj;
  }
  if (obj === null || typeof obj !== "object" && typeof obj !== "function") {
    return {
      default: obj
    };
  }
  var cache = _getRequireWildcardCache(nodeInterop);
  if (cache && cache.has(obj)) {
    return cache.get(obj);
  }
  var newObj = {};
  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;
  for (var key in obj) {
    if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) {
      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;
      if (desc && (desc.get || desc.set)) {
        Object.defineProperty(newObj, key, desc);
      } else {
        newObj[key] = obj[key];
      }
    }
  }
  newObj.default = obj;
  if (cache) {
    cache.set(obj, newObj);
  }
  return newObj;
}
/**
 * Gets the current state. If the selectedValue is controlled,
 * the `value` prop is the source of truth instead of the internal state.
 */
function getControlledState(internalState, props) {
  if (props.value !== undefined) {
    return (0, _extends2.default)({}, internalState, {
      selectedValue: props.value
    });
  }
  return internalState;
}
function areOptionsEqual(option1, option2, optionComparer) {
  if (option1 === option2) {
    return true;
  }
  if (option1 === null || option2 === null) {
    return false;
  }
  return optionComparer(option1, option2);
}

/**
 * Triggers change event handlers (onChange and onHighlightChange) when reducer returns changed state.
 *
 * @param nextState The next state returned by the reducer.
 * @param internalPreviousState The previous state. If the component is controlled, this is merged with the props to determine the final state.
 * @param propsRef The props with defaults applied.
 * @param lastActionRef The last action that was dispatched.
 */
function useStateChangeDetection(nextState, internalPreviousState, propsRef, lastActionRef) {
  React.useEffect(() => {
    var _previousState$select;
    if (!propsRef.current || lastActionRef.current === null) {
      // Detect changes only if an action has been dispatched.
      return;
    }
    if (lastActionRef.current.type === _useListbox.ActionTypes.setValue || lastActionRef.current.type === _useListbox.ActionTypes.setHighlight) {
      // Don't fire change events when the value has been changed externally (e.g. by changing the controlled prop).
      return;
    }
    const previousState = getControlledState(internalPreviousState, propsRef.current);
    const {
      optionComparer,
      onChange
    } = propsRef.current;
    const previousSelectedValues = (_previousState$select = previousState == null ? void 0 : previousState.selectedValues) != null ? _previousState$select : [];
    const nextSelectedValues = nextState.selectedValues;
    if (!(0, _areArraysEqual.default)(nextSelectedValues, previousSelectedValues, optionComparer)) {
      onChange == null ? void 0 : onChange(lastActionRef.current.event, nextSelectedValues);
    }

    // Fires the highlightChange event when reducer returns changed `highlightedValue`.
    if (!areOptionsEqual(internalPreviousState.highlightedValue, nextState.highlightedValue, propsRef.current.optionComparer)) {
      var _propsRef$current, _propsRef$current$onH;
      (_propsRef$current = propsRef.current) == null ? void 0 : (_propsRef$current$onH = _propsRef$current.onHighlightChange) == null ? void 0 : _propsRef$current$onH.call(_propsRef$current, lastActionRef.current.event, nextState.highlightedValue);
    }
    lastActionRef.current = null;
  }, [nextState.selectedValues, nextState.highlightedValue, internalPreviousState, propsRef, lastActionRef]);
}

/**
 * @ignore - do not document.
 */
function useControllableReducer(internalReducer, externalReducer, props) {
  var _ref;
  const {
    value,
    defaultValue
  } = props.current;
  const actionRef = React.useRef(null);
  const initialSelectedValues = (_ref = value === undefined ? defaultValue : value) != null ? _ref : [];
  const initialState = {
    highlightedValue: null,
    selectedValues: initialSelectedValues
  };
  const combinedReducer = React.useCallback((state, action) => {
    actionRef.current = action;
    if (externalReducer) {
      return externalReducer(getControlledState(state, action.props), action);
    }
    return internalReducer(getControlledState(state, action.props), action);
  }, [externalReducer, internalReducer]);
  const [nextState, dispatch] = React.useReducer(combinedReducer, initialState);
  const dispatchWithProps = React.useCallback(action => {
    dispatch((0, _extends2.default)({
      props: props.current
    }, action));
  }, [dispatch, props]);
  const previousState = React.useRef(initialState);
  React.useEffect(() => {
    previousState.current = nextState;
  }, [previousState, nextState]);
  useStateChangeDetection(nextState, previousState.current, props, actionRef);
  return [getControlledState(nextState, props.current), dispatchWithProps];
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZhbHVlIiwiZGVmYXVsdCIsInVzZUNvbnRyb2xsYWJsZVJlZHVjZXIiLCJfZXh0ZW5kczIiLCJSZWFjdCIsIl9pbnRlcm9wUmVxdWlyZVdpbGRjYXJkIiwiX3VzZUxpc3Rib3giLCJfYXJlQXJyYXlzRXF1YWwiLCJfZ2V0UmVxdWlyZVdpbGRjYXJkQ2FjaGUiLCJub2RlSW50ZXJvcCIsIldlYWtNYXAiLCJjYWNoZUJhYmVsSW50ZXJvcCIsImNhY2hlTm9kZUludGVyb3AiLCJvYmoiLCJfX2VzTW9kdWxlIiwiY2FjaGUiLCJoYXMiLCJnZXQiLCJuZXdPYmoiLCJoYXNQcm9wZXJ0eURlc2NyaXB0b3IiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJrZXkiLCJwcm90b3R5cGUiLCJoYXNPd25Qcm9wZXJ0eSIsImNhbGwiLCJkZXNjIiwic2V0IiwiZ2V0Q29udHJvbGxlZFN0YXRlIiwiaW50ZXJuYWxTdGF0ZSIsInByb3BzIiwidW5kZWZpbmVkIiwic2VsZWN0ZWRWYWx1ZSIsImFyZU9wdGlvbnNFcXVhbCIsIm9wdGlvbjEiLCJvcHRpb24yIiwib3B0aW9uQ29tcGFyZXIiLCJ1c2VTdGF0ZUNoYW5nZURldGVjdGlvbiIsIm5leHRTdGF0ZSIsImludGVybmFsUHJldmlvdXNTdGF0ZSIsInByb3BzUmVmIiwibGFzdEFjdGlvblJlZiIsInVzZUVmZmVjdCIsIl9wcmV2aW91c1N0YXRlJHNlbGVjdCIsImN1cnJlbnQiLCJ0eXBlIiwiQWN0aW9uVHlwZXMiLCJzZXRWYWx1ZSIsInNldEhpZ2hsaWdodCIsInByZXZpb3VzU3RhdGUiLCJvbkNoYW5nZSIsInByZXZpb3VzU2VsZWN0ZWRWYWx1ZXMiLCJzZWxlY3RlZFZhbHVlcyIsIm5leHRTZWxlY3RlZFZhbHVlcyIsImV2ZW50IiwiaGlnaGxpZ2h0ZWRWYWx1ZSIsIl9wcm9wc1JlZiRjdXJyZW50IiwiX3Byb3BzUmVmJGN1cnJlbnQkb25IIiwib25IaWdobGlnaHRDaGFuZ2UiLCJpbnRlcm5hbFJlZHVjZXIiLCJleHRlcm5hbFJlZHVjZXIiLCJfcmVmIiwiZGVmYXVsdFZhbHVlIiwiYWN0aW9uUmVmIiwidXNlUmVmIiwiaW5pdGlhbFNlbGVjdGVkVmFsdWVzIiwiaW5pdGlhbFN0YXRlIiwiY29tYmluZWRSZWR1Y2VyIiwidXNlQ2FsbGJhY2siLCJzdGF0ZSIsImFjdGlvbiIsImRpc3BhdGNoIiwidXNlUmVkdWNlciIsImRpc3BhdGNoV2l0aFByb3BzIl0sInNvdXJjZXMiOlsidXNlQ29udHJvbGxhYmxlUmVkdWNlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxudmFyIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQgPSByZXF1aXJlKFwiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9pbnRlcm9wUmVxdWlyZURlZmF1bHRcIik7XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHtcbiAgdmFsdWU6IHRydWVcbn0pO1xuZXhwb3J0cy5kZWZhdWx0ID0gdXNlQ29udHJvbGxhYmxlUmVkdWNlcjtcbnZhciBfZXh0ZW5kczIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2V4dGVuZHNcIikpO1xudmFyIFJlYWN0ID0gX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQocmVxdWlyZShcInJlYWN0XCIpKTtcbnZhciBfdXNlTGlzdGJveCA9IHJlcXVpcmUoXCIuL3VzZUxpc3Rib3gudHlwZXNcIik7XG52YXIgX2FyZUFycmF5c0VxdWFsID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi4vdXRpbHMvYXJlQXJyYXlzRXF1YWxcIikpO1xuZnVuY3Rpb24gX2dldFJlcXVpcmVXaWxkY2FyZENhY2hlKG5vZGVJbnRlcm9wKSB7IGlmICh0eXBlb2YgV2Vha01hcCAhPT0gXCJmdW5jdGlvblwiKSByZXR1cm4gbnVsbDsgdmFyIGNhY2hlQmFiZWxJbnRlcm9wID0gbmV3IFdlYWtNYXAoKTsgdmFyIGNhY2hlTm9kZUludGVyb3AgPSBuZXcgV2Vha01hcCgpOyByZXR1cm4gKF9nZXRSZXF1aXJlV2lsZGNhcmRDYWNoZSA9IGZ1bmN0aW9uIChub2RlSW50ZXJvcCkgeyByZXR1cm4gbm9kZUludGVyb3AgPyBjYWNoZU5vZGVJbnRlcm9wIDogY2FjaGVCYWJlbEludGVyb3A7IH0pKG5vZGVJbnRlcm9wKTsgfVxuZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQob2JqLCBub2RlSW50ZXJvcCkgeyBpZiAoIW5vZGVJbnRlcm9wICYmIG9iaiAmJiBvYmouX19lc01vZHVsZSkgeyByZXR1cm4gb2JqOyB9IGlmIChvYmogPT09IG51bGwgfHwgdHlwZW9mIG9iaiAhPT0gXCJvYmplY3RcIiAmJiB0eXBlb2Ygb2JqICE9PSBcImZ1bmN0aW9uXCIpIHsgcmV0dXJuIHsgZGVmYXVsdDogb2JqIH07IH0gdmFyIGNhY2hlID0gX2dldFJlcXVpcmVXaWxkY2FyZENhY2hlKG5vZGVJbnRlcm9wKTsgaWYgKGNhY2hlICYmIGNhY2hlLmhhcyhvYmopKSB7IHJldHVybiBjYWNoZS5nZXQob2JqKTsgfSB2YXIgbmV3T2JqID0ge307IHZhciBoYXNQcm9wZXJ0eURlc2NyaXB0b3IgPSBPYmplY3QuZGVmaW5lUHJvcGVydHkgJiYgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcjsgZm9yICh2YXIga2V5IGluIG9iaikgeyBpZiAoa2V5ICE9PSBcImRlZmF1bHRcIiAmJiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpKSB7IHZhciBkZXNjID0gaGFzUHJvcGVydHlEZXNjcmlwdG9yID8gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmosIGtleSkgOiBudWxsOyBpZiAoZGVzYyAmJiAoZGVzYy5nZXQgfHwgZGVzYy5zZXQpKSB7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShuZXdPYmosIGtleSwgZGVzYyk7IH0gZWxzZSB7IG5ld09ialtrZXldID0gb2JqW2tleV07IH0gfSB9IG5ld09iai5kZWZhdWx0ID0gb2JqOyBpZiAoY2FjaGUpIHsgY2FjaGUuc2V0KG9iaiwgbmV3T2JqKTsgfSByZXR1cm4gbmV3T2JqOyB9XG4vKipcbiAqIEdldHMgdGhlIGN1cnJlbnQgc3RhdGUuIElmIHRoZSBzZWxlY3RlZFZhbHVlIGlzIGNvbnRyb2xsZWQsXG4gKiB0aGUgYHZhbHVlYCBwcm9wIGlzIHRoZSBzb3VyY2Ugb2YgdHJ1dGggaW5zdGVhZCBvZiB0aGUgaW50ZXJuYWwgc3RhdGUuXG4gKi9cbmZ1bmN0aW9uIGdldENvbnRyb2xsZWRTdGF0ZShpbnRlcm5hbFN0YXRlLCBwcm9wcykge1xuICBpZiAocHJvcHMudmFsdWUgIT09IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiAoMCwgX2V4dGVuZHMyLmRlZmF1bHQpKHt9LCBpbnRlcm5hbFN0YXRlLCB7XG4gICAgICBzZWxlY3RlZFZhbHVlOiBwcm9wcy52YWx1ZVxuICAgIH0pO1xuICB9XG4gIHJldHVybiBpbnRlcm5hbFN0YXRlO1xufVxuZnVuY3Rpb24gYXJlT3B0aW9uc0VxdWFsKG9wdGlvbjEsIG9wdGlvbjIsIG9wdGlvbkNvbXBhcmVyKSB7XG4gIGlmIChvcHRpb24xID09PSBvcHRpb24yKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgaWYgKG9wdGlvbjEgPT09IG51bGwgfHwgb3B0aW9uMiA9PT0gbnVsbCkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuICByZXR1cm4gb3B0aW9uQ29tcGFyZXIob3B0aW9uMSwgb3B0aW9uMik7XG59XG5cbi8qKlxuICogVHJpZ2dlcnMgY2hhbmdlIGV2ZW50IGhhbmRsZXJzIChvbkNoYW5nZSBhbmQgb25IaWdobGlnaHRDaGFuZ2UpIHdoZW4gcmVkdWNlciByZXR1cm5zIGNoYW5nZWQgc3RhdGUuXG4gKlxuICogQHBhcmFtIG5leHRTdGF0ZSBUaGUgbmV4dCBzdGF0ZSByZXR1cm5lZCBieSB0aGUgcmVkdWNlci5cbiAqIEBwYXJhbSBpbnRlcm5hbFByZXZpb3VzU3RhdGUgVGhlIHByZXZpb3VzIHN0YXRlLiBJZiB0aGUgY29tcG9uZW50IGlzIGNvbnRyb2xsZWQsIHRoaXMgaXMgbWVyZ2VkIHdpdGggdGhlIHByb3BzIHRvIGRldGVybWluZSB0aGUgZmluYWwgc3RhdGUuXG4gKiBAcGFyYW0gcHJvcHNSZWYgVGhlIHByb3BzIHdpdGggZGVmYXVsdHMgYXBwbGllZC5cbiAqIEBwYXJhbSBsYXN0QWN0aW9uUmVmIFRoZSBsYXN0IGFjdGlvbiB0aGF0IHdhcyBkaXNwYXRjaGVkLlxuICovXG5mdW5jdGlvbiB1c2VTdGF0ZUNoYW5nZURldGVjdGlvbihuZXh0U3RhdGUsIGludGVybmFsUHJldmlvdXNTdGF0ZSwgcHJvcHNSZWYsIGxhc3RBY3Rpb25SZWYpIHtcbiAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcbiAgICB2YXIgX3ByZXZpb3VzU3RhdGUkc2VsZWN0O1xuICAgIGlmICghcHJvcHNSZWYuY3VycmVudCB8fCBsYXN0QWN0aW9uUmVmLmN1cnJlbnQgPT09IG51bGwpIHtcbiAgICAgIC8vIERldGVjdCBjaGFuZ2VzIG9ubHkgaWYgYW4gYWN0aW9uIGhhcyBiZWVuIGRpc3BhdGNoZWQuXG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChsYXN0QWN0aW9uUmVmLmN1cnJlbnQudHlwZSA9PT0gX3VzZUxpc3Rib3guQWN0aW9uVHlwZXMuc2V0VmFsdWUgfHwgbGFzdEFjdGlvblJlZi5jdXJyZW50LnR5cGUgPT09IF91c2VMaXN0Ym94LkFjdGlvblR5cGVzLnNldEhpZ2hsaWdodCkge1xuICAgICAgLy8gRG9uJ3QgZmlyZSBjaGFuZ2UgZXZlbnRzIHdoZW4gdGhlIHZhbHVlIGhhcyBiZWVuIGNoYW5nZWQgZXh0ZXJuYWxseSAoZS5nLiBieSBjaGFuZ2luZyB0aGUgY29udHJvbGxlZCBwcm9wKS5cbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgcHJldmlvdXNTdGF0ZSA9IGdldENvbnRyb2xsZWRTdGF0ZShpbnRlcm5hbFByZXZpb3VzU3RhdGUsIHByb3BzUmVmLmN1cnJlbnQpO1xuICAgIGNvbnN0IHtcbiAgICAgIG9wdGlvbkNvbXBhcmVyLFxuICAgICAgb25DaGFuZ2VcbiAgICB9ID0gcHJvcHNSZWYuY3VycmVudDtcbiAgICBjb25zdCBwcmV2aW91c1NlbGVjdGVkVmFsdWVzID0gKF9wcmV2aW91c1N0YXRlJHNlbGVjdCA9IHByZXZpb3VzU3RhdGUgPT0gbnVsbCA/IHZvaWQgMCA6IHByZXZpb3VzU3RhdGUuc2VsZWN0ZWRWYWx1ZXMpICE9IG51bGwgPyBfcHJldmlvdXNTdGF0ZSRzZWxlY3QgOiBbXTtcbiAgICBjb25zdCBuZXh0U2VsZWN0ZWRWYWx1ZXMgPSBuZXh0U3RhdGUuc2VsZWN0ZWRWYWx1ZXM7XG4gICAgaWYgKCEoMCwgX2FyZUFycmF5c0VxdWFsLmRlZmF1bHQpKG5leHRTZWxlY3RlZFZhbHVlcywgcHJldmlvdXNTZWxlY3RlZFZhbHVlcywgb3B0aW9uQ29tcGFyZXIpKSB7XG4gICAgICBvbkNoYW5nZSA9PSBudWxsID8gdm9pZCAwIDogb25DaGFuZ2UobGFzdEFjdGlvblJlZi5jdXJyZW50LmV2ZW50LCBuZXh0U2VsZWN0ZWRWYWx1ZXMpO1xuICAgIH1cblxuICAgIC8vIEZpcmVzIHRoZSBoaWdobGlnaHRDaGFuZ2UgZXZlbnQgd2hlbiByZWR1Y2VyIHJldHVybnMgY2hhbmdlZCBgaGlnaGxpZ2h0ZWRWYWx1ZWAuXG4gICAgaWYgKCFhcmVPcHRpb25zRXF1YWwoaW50ZXJuYWxQcmV2aW91c1N0YXRlLmhpZ2hsaWdodGVkVmFsdWUsIG5leHRTdGF0ZS5oaWdobGlnaHRlZFZhbHVlLCBwcm9wc1JlZi5jdXJyZW50Lm9wdGlvbkNvbXBhcmVyKSkge1xuICAgICAgdmFyIF9wcm9wc1JlZiRjdXJyZW50LCBfcHJvcHNSZWYkY3VycmVudCRvbkg7XG4gICAgICAoX3Byb3BzUmVmJGN1cnJlbnQgPSBwcm9wc1JlZi5jdXJyZW50KSA9PSBudWxsID8gdm9pZCAwIDogKF9wcm9wc1JlZiRjdXJyZW50JG9uSCA9IF9wcm9wc1JlZiRjdXJyZW50Lm9uSGlnaGxpZ2h0Q2hhbmdlKSA9PSBudWxsID8gdm9pZCAwIDogX3Byb3BzUmVmJGN1cnJlbnQkb25ILmNhbGwoX3Byb3BzUmVmJGN1cnJlbnQsIGxhc3RBY3Rpb25SZWYuY3VycmVudC5ldmVudCwgbmV4dFN0YXRlLmhpZ2hsaWdodGVkVmFsdWUpO1xuICAgIH1cbiAgICBsYXN0QWN0aW9uUmVmLmN1cnJlbnQgPSBudWxsO1xuICB9LCBbbmV4dFN0YXRlLnNlbGVjdGVkVmFsdWVzLCBuZXh0U3RhdGUuaGlnaGxpZ2h0ZWRWYWx1ZSwgaW50ZXJuYWxQcmV2aW91c1N0YXRlLCBwcm9wc1JlZiwgbGFzdEFjdGlvblJlZl0pO1xufVxuXG4vKipcbiAqIEBpZ25vcmUgLSBkbyBub3QgZG9jdW1lbnQuXG4gKi9cbmZ1bmN0aW9uIHVzZUNvbnRyb2xsYWJsZVJlZHVjZXIoaW50ZXJuYWxSZWR1Y2VyLCBleHRlcm5hbFJlZHVjZXIsIHByb3BzKSB7XG4gIHZhciBfcmVmO1xuICBjb25zdCB7XG4gICAgdmFsdWUsXG4gICAgZGVmYXVsdFZhbHVlXG4gIH0gPSBwcm9wcy5jdXJyZW50O1xuICBjb25zdCBhY3Rpb25SZWYgPSBSZWFjdC51c2VSZWYobnVsbCk7XG4gIGNvbnN0IGluaXRpYWxTZWxlY3RlZFZhbHVlcyA9IChfcmVmID0gdmFsdWUgPT09IHVuZGVmaW5lZCA/IGRlZmF1bHRWYWx1ZSA6IHZhbHVlKSAhPSBudWxsID8gX3JlZiA6IFtdO1xuICBjb25zdCBpbml0aWFsU3RhdGUgPSB7XG4gICAgaGlnaGxpZ2h0ZWRWYWx1ZTogbnVsbCxcbiAgICBzZWxlY3RlZFZhbHVlczogaW5pdGlhbFNlbGVjdGVkVmFsdWVzXG4gIH07XG4gIGNvbnN0IGNvbWJpbmVkUmVkdWNlciA9IFJlYWN0LnVzZUNhbGxiYWNrKChzdGF0ZSwgYWN0aW9uKSA9PiB7XG4gICAgYWN0aW9uUmVmLmN1cnJlbnQgPSBhY3Rpb247XG4gICAgaWYgKGV4dGVybmFsUmVkdWNlcikge1xuICAgICAgcmV0dXJuIGV4dGVybmFsUmVkdWNlcihnZXRDb250cm9sbGVkU3RhdGUoc3RhdGUsIGFjdGlvbi5wcm9wcyksIGFjdGlvbik7XG4gICAgfVxuICAgIHJldHVybiBpbnRlcm5hbFJlZHVjZXIoZ2V0Q29udHJvbGxlZFN0YXRlKHN0YXRlLCBhY3Rpb24ucHJvcHMpLCBhY3Rpb24pO1xuICB9LCBbZXh0ZXJuYWxSZWR1Y2VyLCBpbnRlcm5hbFJlZHVjZXJdKTtcbiAgY29uc3QgW25leHRTdGF0ZSwgZGlzcGF0Y2hdID0gUmVhY3QudXNlUmVkdWNlcihjb21iaW5lZFJlZHVjZXIsIGluaXRpYWxTdGF0ZSk7XG4gIGNvbnN0IGRpc3BhdGNoV2l0aFByb3BzID0gUmVhY3QudXNlQ2FsbGJhY2soYWN0aW9uID0+IHtcbiAgICBkaXNwYXRjaCgoMCwgX2V4dGVuZHMyLmRlZmF1bHQpKHtcbiAgICAgIHByb3BzOiBwcm9wcy5jdXJyZW50XG4gICAgfSwgYWN0aW9uKSk7XG4gIH0sIFtkaXNwYXRjaCwgcHJvcHNdKTtcbiAgY29uc3QgcHJldmlvdXNTdGF0ZSA9IFJlYWN0LnVzZVJlZihpbml0aWFsU3RhdGUpO1xuICBSZWFjdC51c2VFZmZlY3QoKCkgPT4ge1xuICAgIHByZXZpb3VzU3RhdGUuY3VycmVudCA9IG5leHRTdGF0ZTtcbiAgfSwgW3ByZXZpb3VzU3RhdGUsIG5leHRTdGF0ZV0pO1xuICB1c2VTdGF0ZUNoYW5nZURldGVjdGlvbihuZXh0U3RhdGUsIHByZXZpb3VzU3RhdGUuY3VycmVudCwgcHJvcHMsIGFjdGlvblJlZik7XG4gIHJldHVybiBbZ2V0Q29udHJvbGxlZFN0YXRlKG5leHRTdGF0ZSwgcHJvcHMuY3VycmVudCksIGRpc3BhdGNoV2l0aFByb3BzXTtcbn0iXSwibWFwcGluZ3MiOiJBQUFBLFlBQVk7O0FBRVosSUFBSUEsc0JBQXNCLEdBQUdDLE9BQU8sQ0FBQyw4Q0FBOEMsQ0FBQztBQUNwRkMsTUFBTSxDQUFDQyxjQUFjLENBQUND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